---
jupyter:
  jupytext:
    formats: ipynb,Rmd
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.13.7
  kernelspec:
    display_name: R
    language: R
    name: ir
---

<!-- #region tags=[] -->
# Setting up the environment

We'll load the needed libraries:

<!-- #endregion -->

```{r}
# install.packages("styler")
# library(styler)
# styler::style_file(path = "Calculations.Rmd")
```

```{r tags=c()}
# packrat::status()
```

```{r}
options(repr.matrix.max.rows = 100, repr.matrix.max.cols = 300)
options(repr.plot.width = 20, repr.plot.height = 15)
options(width = 300)

numcores <- 56

library(tidyverse)
library(data.table)
library(fst)
library(comorbidity)
library(reshape)
library(dtplyr)
library(haven)
library(vroom)
library(dplyr)
library(stringr)
library(fastmatch)
`%!in%` <- Negate(`%in%`)

setDTthreads(numcores)
```

<!-- #region tags=[] -->
# Codes

First, we will add codes from ICD and Medicare:primary_care_specialty_codes
<!-- #endregion -->

```{r}
# diagnosis codes

office_visit_codes <- c(
  "99201", "99202", "99203", "99204", "99205", "99211", "99212", "99213", "99214",
  "99215"
)

IHD_icd_9_codes <- c(410, 411, 412, 413, 414)
IHD_icd_10_codes <- c("I20", "I21", "I22", "I23", "I24", "I25")

non_us_state_codes <- c(40, 54, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 97, 98, 99)

primary_care_specialty_codes <- c("01", "08", "11", "38")

# http://www.icd9data.com/2015/Volume1/390-459/401-405/default.htm
# https://www.icd10data.com/ICD10CM/Codes/I00-I99/I10-I16
hypertension_icd_9_codes <- c("401", "402", "403", "404", "405")
hypertension_icd_10_codes <- c("I10", "I11", "I12", "I13", "I15", "I16")

# http://www.icd9data.com/2014/Volume1/290-319/295-299/296/default.htm
# https://www.icd10data.com/ICD10CM/Codes/F01-F99/F30-F39
depression_icd_9_codes <- c("2962", "2963")
depression_icd_10_codes <- c("F32", "F33")

# http://www.icd9data.com/2015/Volume1/240-279/249-259/default.htm
# https://www.icd10data.com/ICD10CM/Codes/E00-E89/E08-E13
diabetes_icd_9_codes <- c("250")
diabetes_icd_10_codes <- c("E08", "E09", "E10", "E11", "E13")

# http://www.icd9data.com/2014/Volume1/710-739/710-719/714/default.htm
# https://www.icd10data.com/ICD10CM/Codes/M00-M99/M05-M14
arthritis_icd_9_codes <- c("714")
arthritis_icd_10_codes <- c("M05", "M06", "M07", "M08", "M09", "M10", "M11", "M12", "M13", "M14")


race_codes <- data.frame(
  race_code = seq(0, 6),
  race = c("Unknown", "White", "Black", "Other", "Asian", "Hispanic", "North American Native")
)

sex_codes <- data.frame(
  sex_code = seq(0, 2),
  sex = c("Unknown", "Male", "Female")
)
```

## CMS codes

```{r}
#diagnosis codes

office_visit_codes <- c(
  "99201", "99202", "99203", "99204", "99205", "99211", "99212", "99213", "99214",
  "99215"
)


non_us_state_codes <- c(40, 54, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 97, 98, 99)
primary_care_specialty_codes <- c("01", "08", "11", "38")


race_codes <- data.frame(
  race_code = seq(0, 6),
  race = c("Unknown", "White", "Black", "Other", "Asian", "Hispanic", "North American Native")
)

sex_codes <- data.frame(
  sex_code = seq(0, 2),
  sex = c("Unknown", "Male", "Female")
)


hypertension_icd_9_codes <- c("36211","4010","4011","4019","40200","40201","40210","40211","40290","40291","40300","40301","40310","40311","40390","40391","40400","40401","40402","40403","40410","40411","40412","40413","40490","40491","40492","40493","40501","40509","40511","40519","40591","40599","4372")
hypertension_icd_10_codes <-c("H35031","H35032","H35033","H35039","I10","I110","I119","I120","I129","I130","I1310","I1311","I132","I150","I151","I152","I158","I159","I674","N262")


IHD_icd_9_codes <- c("41000","41001","41002","41010","41011","41012","41020","41021","41022","41030","41031","41032","41040","41041","41042","41050","41051","41052","41060","41061","41062","41070","41071","41072","41080","41081","41082","41090","41091","41092","4110","4111","41181","41189","412","4130","4131","4139","41400","41401","41402","41403","41404","41405","41406","41407","41412","4142","4143","4144","4148","4149")
IHD_icd_10_codes <- c("I200","I201","I208","I209","I2101","I2102","I2109","I2111","I2119","I2121","I2129","I213","I214","I21A1","I21A9","I220","I221","I222","I228","I229","I230","I231","I232","I233","I234","I235","I236","I237","I238","I240","I241","I248","I249","I2510","I25110","I25111","I25118","I25119","I252","I253","I2541","I2542","I255","I256","I25700","I25701","I25708","I25709","I25710","I25711","I25718","I25719","I25720","I25721","I25728","I25729","I25730","I25731","I25738","I25739","I25750","I25751","I25758","I25759","I25760","I25761","I25768","I25769","I25790","I25791","I25798","I25799","I25810","I25811","I25812","I2582","I2583","I2584","I2589","I259")


depression_icd_9_codes <- c("29620","29621","29622","29623","29624","29625","29626","29630","29631","29632","29633","29634","29635","29636","29651","29652","29653","29654","29655","29656","29660","29661","29662","29663","29664","29665","29666","29689","2980","3004","3091","311")
depression_icd_10_codes <- c("F3130","F3131","F3132","F314","F315","F3160","F3161","F3162","F3163","F3164","F3175","F3176","F3177","F3178","F3181","F320","F321","F322","F323","F324","F325","F329","F330","F331","F332","F333","F3340","F3341","F3342","F338","F339","F341","F4321","F4323")



diabetes_icd_9_codes <- c("24900","24901","24910","24911","24920","24921","24930","24931","24940","24941","24950","24951","24960","24961","24970","24971","24980","24981","24990","24991","25000","25001","25002","25003","25010","25011","25012","25013","25020","25021","25022","25023","25030","25031","25032","25033","25040","25041","25042","25043","25050","25051","25052","25053","25060","25061","25062","25063","25070","25071","25072","25073","25080","25081","25082","25083","25090","25091","25092","25093","3572","36201","36202","36203","36204","36205","36206","36641")
diabetes_icd_10_codes <- c("E0800","E0801","E0810","E0811","E0821","E0822","E0829","E08311","E08319","E08321","E083211","E083212","E083213","E083219","E08329","E083291","E083292","E083293","E083299","E08331","E083311","E083312","E083313","E083319","E08339","E083391","E083392","E083393","E083399","E08341","E083411","E083412","E083413","E083419","E08349","E083491","E083492","E083493","E083499","E08351","E083511","E083512","E083513","E083519","E083521","E083522","E083523","E083529","E083531","E083532","E083533","E083539","E083541","E083542","E083543","E083549","E083551","E083552","E083553","E083559","E08359","E083591","E083592","E083593","E083599","E0836","E0837X1","E0837X2","E0837X3","E0837X9","E0839","E0840","E0841","E0842","E0843","E0844","E0849","E0851","E0852","E0859","E08610","E08618","E08620","E08621","E08622","E08628","E08630","E08638","E08641","E08649","E0865","E0869","E088","E089","E0900","E0901","E0910","E0911","E0921","E0922","E0929","E09311","E09319","E09321","E093211","E093212","E093213","E093219","E09329","E093291","E093292","E093293","E093299","E09331","E093311","E093312","E093313","E093319","E09339","E093391","E093392","E093393","E093399","E09341","E093411","E093412","E093413","E093419","E09349","E093491","E093492","E093493","E093499","E09351","E093511","E093512","E093513","E093519","E093521","E093522","E093523","E093529","E093531","E093532","E093533","E093539","E093541","E093542","E093543","E093549","E093551","E093552","E093553","E093559","E09359","E093591","E093592","E093593","E093599","E0936","E0937X1","E0937X2","E0937X3","E0937X9","E0939","E0940","E0941","E0942","E0943","E0944","E0949","E0951","E0952","E0959","E09610","E09618","E09620","E09621","E09622","E09628","E09630","E09638","E09641","E09649","E0965","E0969","E098","E099","E1010","E1011","E1021","E1022","E1029","E10311","E10319","E10321","E103211","E103212","E103213","E103219","E10329","E103291","E103292","E103293","E103299","E10331","E103311","E103312","E103313","E103319","E10339","E103391","E103392","E103393","E103399","E10341","E103411","E103412","E103413","E103419","E10349","E103491","E103492","E103493","E103499","E10351","E103511","E103512","E103513","E103519","E103521","E103522","E103523","E103529","E103531","E103532","E103533","E103539","E103541","E103542","E103543","E103549","E103551","E103552","E103553","E103559","E10359","E103591","E103592","E103593","E103599","E1036","E1037X1","E1037X2","E1037X3","E1037X9","E1039","E1040","E1041","E1042","E1043","E1044","E1049","E1051","E1052","E1059","E10610","E10618","E10620","E10621","E10622","E10628","E10630","E10638","E10641","E10649","E1065","E1069","E108","E109","E1100","E1101","E1110","E1111","E1121","E1122","E1129","E11311","E11319","E11321","E113211","E113212","E113213","E113219","E11329","E113291","E113292","E113293","E113299","E11331","E113311","E113312","E113313","E113319","E11339","E113391","E113392","E113393","E113399","E11341","E113411","E113412","E113413","E113419","E11349","E113491","E113492","E113493","E113499","E11351","E113511","E113512","E113513","E113519","E113521","E113522","E113523","E113529","E113531","E113532","E113533","E113539","E113541","E113542","E113543","E113549","E113551","E113552","E113553","E113559","E11359","E113591","E113592","E113593","E113599","E1136","E1137X1","E1137X2","E1137X3","E1137X9","E1139","E1140","E1141","E1142","E1143","E1144","E1149","E1151","E1152","E1159","E11610","E11618","E11620","E11621","E11622","E11628","E11630","E11638","E11641","E11649","E1165","E1169","E118","E119","E1300","E1301","E1310","E1311","E1321","E1322","E1329","E13311","E13319","E13321","E133211","E133212","E133213","E133219","E13329","E133291","E133292","E133293","E133299","E13331","E133311","E133312","E133313","E133319","E13339","E133391","E133392","E133393","E133399","E13341","E133411","E133412","E133413","E133419","E13349","E133491","E133492","E133493","E133499","E13351","E133511","E133512","E133513","E133519","E133521","E133522","E133523","E133529","E133531","E133532","E133533","E133539","E133541","E133542","E133543","E133549","E133551","E133552","E133553","E133559","E13359","E133591","E133592","E133593","E133599","E1336","E1339","E1340","E1341","E1342","E1343","E1344","E1349","E1351","E1352","E1359","E13610","E13618","E13620","E13621","E13622","E13628","E13630","E13638","E13641","E13649","E1365","E1369","E138","E139")



arthritis_icd_9_codes <- c("7140","7141","7142","71430","71431","71432","71433","71500","71504","71509","71510","71511","71512","71513","71514","71515","71516","71517","71518","71520","71521","71522","71523","71524","71525","71526","71527","71528","71530","71531","71532","71533","71534","71535","71536","71537","71538","71580","71589","71590","71591","71592","71593","71594","71595","71596","71597","71598","7200","7210","7211","7212","7213","72190","72191")
arthritis_icd_10_codes <- c("M0500","M05011","M05012","M05019","M05021","M05022","M05029","M05031","M05032","M05039","M05041","M05042","M05049","M05051","M05052","M05059","M05061","M05062","M05069","M05071","M05072","M05079","M0509","M0520","M05211","M05212","M05219","M05221","M05222","M05229","M05231","M05232","M05239","M05241","M05242","M05249","M05251","M05252","M05259","M05261","M05262","M05269","M05271","M05272","M05279","M0529","M0530","M05311","M05312","M05319","M05321","M05322","M05329","M05331","M05332","M05339","M05341","M05342","M05349","M05351","M05352","M05359","M05361","M05362","M05369","M05371","M05372","M05379","M0539","M0540","M05411","M05412","M05419","M05421","M05422","M05429","M05431","M05432","M05439","M05441","M05442","M05449","M05451","M05452","M05459","M05461","M05462","M05469","M05471","M05472","M05479","M0549","M0550","M05511","M05512","M05519","M05521","M05522","M05529","M05531","M05532","M05539","M05541","M05542","M05549","M05551","M05552","M05559","M05561","M05562","M05569","M05571","M05572","M05579","M0559","M0560","M05611","M05612","M05619","M05621","M05622","M05629","M05631","M05632","M05639","M05641","M05642","M05649","M05651","M05652","M05659","M05661","M05662","M05669","M05671","M05672","M05679","M0569","M0570","M05711","M05712","M05719","M05721","M05722","M05729","M05731","M05732","M05739","M05741","M05742","M05749","M05751","M05752","M05759","M05761","M05762","M05769","M05771","M05772","M05779","M0579","M057A","M0580","M05811","M05812","M05819","M05821","M05822","M05829","M05831","M05832","M05839","M05841","M05842","M05849","M05851","M05852","M05859","M05861","M05862","M05869","M05871","M05872","M05879","M0589","M058A","M059","M0600","M06011","M06012","M06019","M06021","M06022","M06029","M06031","M06032","M06039","M06041","M06042","M06049","M06051","M06052","M06059","M06061","M06062","M06069","M06071","M06072","M06079","M0608","M0609","M060A","M061","M0620","M06211","M06212","M06219","M06221","M06222","M06229","M06231","M06232","M06239","M06241","M06242","M06249","M06251","M06252","M06259","M06261","M06262","M06269","M06271","M06272","M06279","M0628","M0629","M0630","M06311","M06312","M06319","M06321","M06322","M06329","M06331","M06332","M06339","M06341","M06342","M06349","M06351","M06352","M06359","M06361","M06362","M06369","M06371","M06372","M06379","M0638","M0639","M0680","M06811","M06812","M06819","M06821","M06822","M06829","M06831","M06832","M06839","M06841","M06842","M06849","M06851","M06852","M06859","M06861","M06862","M06869","M06871","M06872","M06879","M0688","M0689","M068A","M069","M0800","M08011","M08012","M08019","M08021","M08022","M08029","M08031","M08032","M08039","M08041","M08042","M08049","M08051","M08052","M08059","M08061","M08062","M08069","M08071","M08072","M08079","M0808","M0809","M080A","M081","M0820","M08211","M08212","M08219","M08221","M08222","M08229","M08231","M08232","M08239","M08241","M08242","M08249","M08251","M08252","M08259","M08261","M08262","M08269","M08271","M08272","M08279","M0828","M0829","M082A","M083","M0840","M08411","M08412","M08419","M08421","M08422","M08429","M08431","M08432","M08439","M08441","M08442","M08449","M08451","M08452","M08459","M08461","M08462","M08469","M08471","M08472","M08479","M0848","M084A","M0880","M08811","M08812","M08819","M08821","M08822","M08829","M08831","M08832","M08839","M08841","M08842","M08849","M08851","M08852","M08859","M08861","M08862","M08869","M08871","M08872","M08879","M0888","M0889","M0890","M08911","M08912","M08919","M08921","M08922","M08929","M08931","M08932","M08939","M08941","M08942","M08949","M08951","M08952","M08959","M08961","M08962","M08969","M08971","M08972","M08979","M0898","M0899","M089A","M150","M151","M152","M153","M154","M158","M159","M160","M1610","M1611","M1612","M162","M1630","M1631","M1632","M164","M1650","M1651","M1652","M166","M167","M169","M170","M1710","M1711","M1712","M172","M1730","M1731","M1732","M174","M175","M179","M180","M1810","M1811","M1812","M182","M1830","M1831","M1832","M184","M1850","M1851","M1852","M189","M19011","M19012","M19019","M19021","M19022","M19029","M19031","M19032","M19039","M19041","M19042","M19049","M19071","M19072","M19079","M1909","M19111","M19112","M19119","M19121","M19122","M19129","M19131","M19132","M19139","M19141","M19142","M19149","M19171","M19172","M19179","M1919","M19211","M19212","M19219","M19221","M19222","M19229","M19231","M19232","M19239","M19241","M19242","M19249","M19271","M19272","M19279","M1929","M1990","M1991","M1992","M1993","M450","M451","M452","M453","M454","M455","M456","M457","M458","M459","M47011","M47012","M47013","M47014","M47015","M47016","M47019","M47021","M47022","M47029","M4710","M4711","M4712","M4713","M4720","M4721","M4722","M4723","M4724","M4725","M4726","M4727","M4728","M47811","M47812","M47813","M47814","M47815","M47816","M47817","M47818","M47819","M47891","M47892","M47893","M47894","M47895","M47896","M47897","M47898","M47899","M479","M488X1","M488X2","M488X3","M488X4","M488X5","M488X6","M488X7","M488X8","M488X9")




```

<!-- #region jp-MarkdownHeadingCollapsed=true tags=[] jp-MarkdownHeadingCollapsed=true -->
## CMS codes sepparated
<!-- #endregion -->

```{r}
office_visit_codes <- c(
  "99201", "99202", "99203", "99204", "99205", "99211", "99212", "99213", "99214",
  "99215"
)


non_us_state_codes <- c(40, 54, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 97, 98, 99)
primary_care_specialty_codes <- c("01", "08", "11", "38")


race_codes <- data.frame(
  race_code = seq(0, 6),
  race = c("Unknown", "White", "Black", "Other", "Asian", "Hispanic", "North American Native")
)

sex_codes <- data.frame(
  sex_code = seq(0, 2),
  sex = c("Unknown", "Male", "Female")
)



hypertension_icd_9_codes <- c("36211","4010","4011","4019","40200","40201","40210","40211","40290","40291","40300","40301","40310","40311","40390","40391","40400","40401","40402","40403","40410","40411","40412","40413","40490","40491","40492","40493","40501","40509","40511","40519","40591","40599","4372")
hypertension_icd_10_codes <-c("H35031","H35032","H35033","H35039","I10","I110","I119","I120","I129","I130","I1310","I1311","I132","I150","I151","I152","I158","I159","I674","N262")


IHD_icd_9_codes <- c("41000","41001","41002","41010","41011","41012","41020","41021","41022","41030","41031","41032","41040","41041","41042","41050","41051","41052","41060","41061","41062","41070","41071","41072","41080","41081","41082","41090","41091","41092","4110","4111","41181","41189","412","4130","4131","4139","41400","41401","41402","41403","41404","41405","41406","41407","41412","4142","4143","4144","4148","4149")
IHD_icd_10_codes <- c("I200","I201","I208","I209","I2101","I2102","I2109","I2111","I2119","I2121","I2129","I213","I214","I21A1","I21A9","I220","I221","I222","I228","I229","I230","I231","I232","I233","I234","I235","I236","I237","I238","I240","I241","I248","I249","I2510","I25110","I25111","I25118","I25119","I252","I253","I2541","I2542","I255","I256","I25700","I25701","I25708","I25709","I25710","I25711","I25718","I25719","I25720","I25721","I25728","I25729","I25730","I25731","I25738","I25739","I25750","I25751","I25758","I25759","I25760","I25761","I25768","I25769","I25790","I25791","I25798","I25799","I25810","I25811","I25812","I2582","I2583","I2584","I2589","I259")


depression_icd_9_codes <- c("29620","29621","29622","29623","29624","29625","29626","29630","29631","29632","29633","29634","29635","29636","29651","29652","29653","29654","29655","29656","29660","29661","29662","29663","29664","29665","29666","29689","2980","3004","3091","311")
depression_icd_10_codes <- c("F3130","F3131","F3132","F314","F315","F3160","F3161","F3162","F3163","F3164","F3175","F3176","F3177","F3178","F3181","F320","F321","F322","F323","F324","F325","F329","F330","F331","F332","F333","F3340","F3341","F3342","F338","F339","F341","F4321","F4323")



diabetes_icd_9_codes <- c("24900","24901","24910","24911","24920","24921","24930","24931","24940","24941","24950","24951","24960","24961","24970","24971","24980","24981","24990","24991","25000","25001","25002","25003","25010","25011","25012","25013","25020","25021","25022","25023","25030","25031","25032","25033","25040","25041","25042","25043","25050","25051","25052","25053","25060","25061","25062","25063","25070","25071","25072","25073","25080","25081","25082","25083","25090","25091","25092","25093","3572","36201","36202","36203","36204","36205","36206","36641")

diabetes_icd_10_codes_1 <- c("E0800","E0801","E0810","E0811","E0821","E0822","E0829","E08311","E08319","E08321","E083211","E083212","E083213","E083219","E08329","E083291","E083292","E083293","E083299","E08331","E083311","E083312","E083313","E083319","E08339","E083391","E083392","E083393","E083399","E08341","E083411","E083412","E083413","E083419","E08349","E083491","E083492","E083493","E083499","E08351","E083511","E083512","E083513","E083519","E083521","E083522","E083523","E083529","E083531","E083532","E083533","E083539","E083541","E083542","E083543","E083549","E083551","E083552","E083553","E083559","E08359","E083591","E083592","E083593","E083599","E0836","E0837X1","E0837X2","E0837X3","E0837X9","E0839","E0840","E0841","E0842","E0843","E0844","E0849","E0851","E0852","E0859","E08610","E08618","E08620","E08621","E08622","E08628","E08630","E08638","E08641","E08649","E0865","E0869","E088","E089","E0900","E0901","E0910","E0911","E0921","E0922","E0929","E09311","E09319","E09321")
                             
                             
diabetes_icd_10_codes_2 <- c("E093211","E093212","E093213","E093219","E09329","E093291","E093292","E093293","E093299","E09331","E093311","E093312","E093313","E093319","E09339","E093391","E093392","E093393","E093399","E09341","E093411","E093412","E093413","E093419","E09349","E093491","E093492","E093493","E093499","E09351","E093511","E093512","E093513","E093519","E093521","E093522","E093523","E093529","E093531","E093532","E093533","E093539","E093541","E093542","E093543","E093549","E093551","E093552","E093553","E093559","E09359","E093591","E093592","E093593","E093599","E0936","E0937X1","E0937X2","E0937X3","E0937X9","E0939","E0940","E0941","E0942","E0943","E0944","E0949","E0951","E0952","E0959","E09610","E09618","E09620","E09621","E09622","E09628","E09630","E09638","E09641","E09649","E0965","E0969","E098","E099","E1010","E1011","E1021","E1022","E1029","E10311","E10319","E10321","E103211","E103212","E103213","E103219","E10329","E103291","E103292","E103293","E103299","E10331","E103311","E103312","E103313","E103319","E10339","E103391","E103392","E103393","E103399","E10341","E103411")


diabetes_icd_10_codes_3 <- c("E103412","E103413","E103419","E10349","E103491","E103492","E103493","E103499","E10351","E103511","E103512","E103513","E103519","E103521","E103522","E103523","E103529","E103531","E103532","E103533","E103539","E103541","E103542","E103543","E103549","E103551","E103552","E103553","E103559","E10359","E103591","E103592","E103593","E103599","E1036","E1037X1","E1037X2","E1037X3","E1037X9","E1039","E1040","E1041","E1042","E1043","E1044","E1049","E1051","E1052","E1059","E10610","E10618","E10620","E10621","E10622","E10628","E10630","E10638","E10641","E10649","E1065","E1069","E108","E109","E1100","E1101","E1110","E1111","E1121","E1122","E1129","E11311","E11319","E11321","E113211","E113212","E113213","E113219","E11329","E113291","E113292","E113293","E113299","E11331","E113311","E113312","E113313","E113319","E11339","E113391","E113392","E113393","E113399","E11341","E113411","E113412","E113413","E113419","E11349","E113491","E113492","E113493","E113499","E11351","E113511","E113512","E113513","E113519","E113521","E113522","E113523","E113529","E113531","E113532","E113533","E113539","E113541","E113542","E113543","E113549","E113551","E113552","E113553","E113559","E11359","E113591","E113592")

diabetes_icd_10_codes_4 <-                             
c("E113593","E113599","E1136","E1137X1","E1137X2","E1137X3","E1137X9","E1139","E1140","E1141","E1142","E1143","E1144","E1149","E1151","E1152","E1159","E11610","E11618","E11620","E11621","E11622","E11628","E11630","E11638","E11641","E11649","E1165","E1169","E118","E119","E1300","E1301","E1310","E1311","E1321","E1322","E1329","E13311","E13319","E13321","E133211","E133212","E133213","E133219","E13329","E133291","E133292","E133293","E133299","E13331","E133311","E133312","E133313","E133319","E13339","E133391","E133392","E133393","E133399","E13341","E133411","E133412","E133413","E133419","E13349","E133491","E133492","E133493","E133499","E13351","E133511","E133512","E133513","E133519","E133521","E133522","E133523","E133529","E133531","E133532","E133533","E133539","E133541","E133542","E133543","E133549","E133551","E133552","E133553","E133559","E13359","E133591","E133592","E133593","E133599","E1336","E1339","E1340","E1341","E1342","E1343","E1344","E1349","E1351","E1352","E1359","E13610","E13618","E13620","E13621","E13622","E13628","E13630","E13638","E13641","E13649","E1365","E1369","E138","E139")


arthritis_icd_9_codes <- c("7140","7141","7142","71430","71431","71432","71433","71500","71504","71509","71510","71511","71512","71513","71514","71515","71516","71517","71518","71520","71521","71522","71523","71524","71525","71526","71527","71528","71530","71531","71532","71533","71534","71535","71536","71537","71538","71580","71589","71590","71591","71592","71593","71594","71595","71596","71597","71598","7200","7210","7211","7212","7213","72190","72191")


arthritis_icd_10_codes_1 <- c("M0500","M05011","M05012","M05019","M05021","M05022","M05029","M05031","M05032","M05039","M05041","M05042","M05049","M05051","M05052","M05059","M05061","M05062","M05069","M05071","M05072","M05079","M0509","M0520","M05211","M05212","M05219","M05221","M05222","M05229","M05231","M05232","M05239","M05241","M05242","M05249","M05251","M05252","M05259","M05261","M05262","M05269","M05271","M05272","M05279","M0529","M0530","M05311","M05312","M05319","M05321","M05322","M05329","M05331","M05332","M05339","M05341","M05342","M05349","M05351","M05352","M05359","M05361","M05362","M05369","M05371","M05372","M05379","M0539","M0540","M05411","M05412","M05419","M05421","M05422","M05429","M05431","M05432","M05439","M05441","M05442","M05449","M05451","M05452","M05459","M05461","M05462","M05469","M05471","M05472","M05479","M0549","M0550","M05511","M05512","M05519","M05521","M05522","M05529","M05531","M05532","M05539","M05541","M05542","M05549","M05551","M05552","M05559","M05561","M05562","M05569","M05571","M05572","M05579","M0559","M0560","M05611","M05612","M05619","M05621","M05622","M05629","M05631","M05632","M05639","M05641","M05642","M05649","M05651","M05652","M05659","M05661","M05662","M05669","M05671","M05672")

arthritis_icd_10_codes_2 <- c("M05679","M0569","M0570","M05711","M05712","M05719","M05721","M05722","M05729","M05731","M05732","M05739","M05741","M05742","M05749","M05751","M05752","M05759","M05761","M05762","M05769","M05771","M05772","M05779","M0579","M057A","M0580","M05811","M05812","M05819","M05821","M05822","M05829","M05831","M05832","M05839","M05841","M05842","M05849","M05851","M05852","M05859","M05861","M05862","M05869","M05871","M05872","M05879","M0589","M058A","M059","M0600","M06011","M06012","M06019","M06021","M06022","M06029","M06031","M06032","M06039","M06041","M06042","M06049","M06051","M06052","M06059","M06061","M06062","M06069","M06071","M06072","M06079","M0608","M0609","M060A","M061","M0620","M06211","M06212","M06219","M06221","M06222","M06229","M06231","M06232","M06239","M06241","M06242","M06249","M06251","M06252","M06259","M06261","M06262","M06269","M06271","M06272","M06279","M0628","M0629","M0630","M06311","M06312","M06319","M06321","M06322","M06329","M06331","M06332","M06339","M06341","M06342","M06349","M06351","M06352","M06359","M06361","M06362","M06369","M06371","M06372","M06379","M0638","M0639","M0680","M06811","M06812","M06819","M06821","M06822","M06829","M06831","M06832","M06839","M06841","M06842","M06849","M06851","M06852","M06859","M06861","M06862","M06869","M06871","M06872","M06879")


arthritis_icd_10_codes_3 <- c("M0688","M0689","M068A","M069","M0800","M08011","M08012","M08019","M08021","M08022","M08029","M08031","M08032","M08039","M08041","M08042","M08049","M08051","M08052","M08059","M08061","M08062","M08069","M08071","M08072","M08079","M0808","M0809","M080A","M081","M0820","M08211","M08212","M08219","M08221","M08222","M08229","M08231","M08232","M08239","M08241","M08242","M08249","M08251","M08252","M08259","M08261","M08262","M08269","M08271","M08272","M08279","M0828","M0829","M082A","M083","M0840","M08411","M08412","M08419","M08421","M08422","M08429","M08431","M08432","M08439","M08441","M08442","M08449","M08451","M08452","M08459","M08461","M08462","M08469","M08471","M08472","M08479","M0848","M084A","M0880","M08811","M08812","M08819","M08821","M08822","M08829","M08831","M08832","M08839","M08841","M08842","M08849","M08851","M08852","M08859","M08861","M08862","M08869","M08871","M08872","M08879","M0888","M0889","M0890","M08911","M08912","M08919","M08921","M08922","M08929","M08931","M08932","M08939","M08941","M08942","M08949","M08951","M08952","M08959","M08961","M08962","M08969","M08971","M08972","M08979","M0898","M0899","M089A","M150","M151","M152","M153","M154","M158","M159","M160","M1610","M1611","M1612","M162","M1630","M1631","M1632","M164","M1650","M1651","M1652","M166","M167")
                              
                              
arthritis_icd_10_codes_4 <- c("M169","M170","M1710","M1711","M1712","M172","M1730","M1731","M1732","M174","M175","M179","M180","M1810","M1811","M1812","M182","M1830","M1831","M1832","M184","M1850","M1851","M1852","M189","M19011","M19012","M19019","M19021","M19022","M19029","M19031","M19032","M19039","M19041","M19042","M19049","M19071","M19072","M19079","M1909","M19111","M19112","M19119","M19121","M19122","M19129","M19131","M19132","M19139","M19141","M19142","M19149","M19171","M19172","M19179","M1919","M19211","M19212","M19219","M19221","M19222","M19229","M19231","M19232","M19239","M19241","M19242","M19249","M19271","M19272","M19279","M1929","M1990","M1991","M1992","M1993","M450","M451","M452","M453","M454","M455","M456","M457","M458","M459","M47011","M47012","M47013","M47014","M47015","M47016","M47019","M47021","M47022","M47029","M4710","M4711","M4712","M4713","M4720","M4721","M4722","M4723","M4724","M4725","M4726","M4727","M4728","M47811","M47812","M47813","M47814","M47815","M47816","M47817","M47818","M47819","M47891","M47892","M47893","M47894","M47895","M47896","M47897","M47898","M47899","M479","M488X1","M488X2","M488X3","M488X4","M488X5","M488X6","M488X7","M488X8","M488X9")
```

<!-- #region tags=[] toc-hr-collapsed=true jp-MarkdownHeadingCollapsed=true jp-MarkdownHeadingCollapsed=true jp-MarkdownHeadingCollapsed=true jp-MarkdownHeadingCollapsed=true tags=[] jp-MarkdownHeadingCollapsed=true -->
# Patient level calculations
<!-- #endregion -->

<!-- #region tags=[] jp-MarkdownHeadingCollapsed=true tags=[] -->
## Yearly Calculators

These are the main functions that calculate yearly expenditures for patients and their corresponding physicians.\
<!-- #endregion -->

<!-- #region jp-MarkdownHeadingCollapsed=true tags=[] jp-MarkdownHeadingCollapsed=true jp-MarkdownHeadingCollapsed=true tags=[] jp-MarkdownHeadingCollapsed=true jp-MarkdownHeadingCollapsed=true tags=[] jp-MarkdownHeadingCollapsed=true -->
### Fixing the MBSF data
<!-- #endregion -->

```{r jupyter={'outputs_hidden': True}, tags=c()}
mbsf_2013 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/MBSF/den_saf_lds_5_2013.csv", num_threads = numcores) %>% as.data.table()
mbsf_2014 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/MBSF/den_saf_lds_5_2014.csv", num_threads = numcores) %>% as.data.table()
mbsf_2015 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/MBSF/den_saf_lds_5_2015.csv", num_threads = numcores) %>% as.data.table()
mbsf_2016 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/MBSF/mbsf_lds_5_2016.csv", num_threads = numcores) %>% as.data.table()
mbsf_2017 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/MBSF/mbsf_lds_5_2017.csv", num_threads = numcores) %>% as.data.table()
mbsf_2018 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/MBSF/mbsf_lds_5_2018.csv", num_threads = numcores) %>% as.data.table()
mbsf_2019 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/MBSF/mbsf_lds_5_2019.csv", num_threads = numcores) %>% as.data.table()
mbsf_2020 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/MBSF/mbsf_lds_5_2020.csv", num_threads = numcores) %>% as.data.table()
```

```{r}
mbsf_colnames_2013_2015 <- c("DESY_SORT_KEY", "STATE_CODE", "COUNTY_CODE", "SEX_CODE", "RACE_CODE", "AGE", "ORIG_REASON_FOR_ENTITLEMENT", "CURR_REASON_FOR_ENTITLEMENT", "ESRD_INDICATOR", "MEDICARE_STATUS_CD", "PART_A_TERMINATION_CODE", "PART_B_TERMINATION_CODE", "ENTITLEMENT_BUY_IN_IND01", "ENTITLEMENT_BUY_IN_IND02", "ENTITLEMENT_BUY_IN_IND03", "ENTITLEMENT_BUY_IN_IND04", "ENTITLEMENT_BUY_IN_IND05", "ENTITLEMENT_BUY_IN_IND06", "ENTITLEMENT_BUY_IN_IND07", "ENTITLEMENT_BUY_IN_IND08", "ENTITLEMENT_BUY_IN_IND09", "ENTITLEMENT_BUY_IN_IND10", "ENTITLEMENT_BUY_IN_IND11", "ENTITLEMENT_BUY_IN_IND12", "HMO_INDICATOR01", "HMO_INDICATOR02", "HMO_INDICATOR03", "HMO_INDICATOR04", "HMO_INDICATOR05", "HMO_INDICATOR06", "HMO_INDICATOR07", "HMO_INDICATOR08", "HMO_INDICATOR09", "HMO_INDICATOR10", "HMO_INDICATOR11", "HMO_INDICATOR12", "HI_COVERAGE", "SMI_COVERAGE", "HMO_COVERAGE", "STATE_BUY_IN_COVERAGE", "VALID_DATE_OF_DEATH_SWITCH", "DATE_OF_DEATH", "REFERENCE_YEAR")

mbsf_colnames_2016_2020 <- c("DESY_SORT_KEY", "REFERENCE_YEAR", "SAMPLE_GROUP", "STATE_CODE", "COUNTY_CODE", "STATE_CNTY_FIPS_CD_01", "STATE_CNTY_FIPS_CD_02", "STATE_CNTY_FIPS_CD_03", "STATE_CNTY_FIPS_CD_04", "STATE_CNTY_FIPS_CD_05", "STATE_CNTY_FIPS_CD_06", "STATE_CNTY_FIPS_CD_07", "STATE_CNTY_FIPS_CD_08", "STATE_CNTY_FIPS_CD_09", "STATE_CNTY_FIPS_CD_10", "STATE_CNTY_FIPS_CD_11", "STATE_CNTY_FIPS_CD_12", "SEX_CODE", "RACE_CODE", "AGE", "ORIG_REASON_FOR_ENTITLEMENT", "CURR_REASON_FOR_ENTITLEMENT", "ESRD_INDICATOR", "MDCR_STATUS_CODE_01", "MDCR_STATUS_CODE_02", "MDCR_STATUS_CODE_03", "MDCR_STATUS_CODE_04", "MDCR_STATUS_CODE_05", "MDCR_STATUS_CODE_06", "MDCR_STATUS_CODE_07", "MDCR_STATUS_CODE_08", "MDCR_STATUS_CODE_09", "MDCR_STATUS_CODE_10", "MDCR_STATUS_CODE_11", "MDCR_STATUS_CODE_12", "PART_A_TERMINATION_CODE", "PART_B_TERMINATION_CODE", "ENTITLEMENT_BUY_IN_IND01", "ENTITLEMENT_BUY_IN_IND02", "ENTITLEMENT_BUY_IN_IND03", "ENTITLEMENT_BUY_IN_IND04", "ENTITLEMENT_BUY_IN_IND05", "ENTITLEMENT_BUY_IN_IND06", "ENTITLEMENT_BUY_IN_IND07", "ENTITLEMENT_BUY_IN_IND08", "ENTITLEMENT_BUY_IN_IND09", "ENTITLEMENT_BUY_IN_IND10", "ENTITLEMENT_BUY_IN_IND11", "ENTITLEMENT_BUY_IN_IND12", "HMO_INDICATOR01", "HMO_INDICATOR02", "HMO_INDICATOR03", "HMO_INDICATOR04", "HMO_INDICATOR05", "HMO_INDICATOR06", "HMO_INDICATOR07", "HMO_INDICATOR08", "HMO_INDICATOR09", "HMO_INDICATOR10", "HMO_INDICATOR11", "HMO_INDICATOR12", "HI_COVERAGE", "SMI_COVERAGE", "HMO_COVERAGE", "STATE_BUY_IN_COVERAGE", "VALID_DATE_OF_DEATH_SWITCH", "DATE_OF_DEATH", "DUAL_STUS_CD_01", "DUAL_STUS_CD_02", "DUAL_STUS_CD_03", "DUAL_STUS_CD_04", "DUAL_STUS_CD_05", "DUAL_STUS_CD_06", "DUAL_STUS_CD_07", "DUAL_STUS_CD_08", "DUAL_STUS_CD_09", "DUAL_STUS_CD_10", "DUAL_STUS_CD_11", "DUAL_STUS_CD_12")


colnames(mbsf_2013) <- mbsf_colnames_2013_2015
colnames(mbsf_2014) <- mbsf_colnames_2013_2015
colnames(mbsf_2015) <- mbsf_colnames_2013_2015
colnames(mbsf_2016) <- mbsf_colnames_2016_2020
colnames(mbsf_2017) <- mbsf_colnames_2016_2020
colnames(mbsf_2018) <- mbsf_colnames_2016_2020
colnames(mbsf_2019) <- mbsf_colnames_2016_2020
colnames(mbsf_2020) <- mbsf_colnames_2016_2020
```

```{r}
mbsf_needed_cols <- c(
  "DESY_SORT_KEY",
  "REFERENCE_YEAR",
  "STATE_CODE",
  "COUNTY_CODE",
  "SEX_CODE",
  "RACE_CODE",
  "AGE",
  "ORIG_REASON_FOR_ENTITLEMENT",
  "CURR_REASON_FOR_ENTITLEMENT",
  "ENTITLEMENT_BUY_IN_IND01",
  "ENTITLEMENT_BUY_IN_IND02",
  "ENTITLEMENT_BUY_IN_IND03",
  "ENTITLEMENT_BUY_IN_IND04",
  "ENTITLEMENT_BUY_IN_IND05",
  "ENTITLEMENT_BUY_IN_IND06",
  "ENTITLEMENT_BUY_IN_IND07",
  "ENTITLEMENT_BUY_IN_IND08",
  "ENTITLEMENT_BUY_IN_IND09",
  "ENTITLEMENT_BUY_IN_IND10",
  "ENTITLEMENT_BUY_IN_IND11",
  "ENTITLEMENT_BUY_IN_IND12",
  "HMO_INDICATOR01",
  "HMO_INDICATOR02",
  "HMO_INDICATOR03",
  "HMO_INDICATOR04",
  "HMO_INDICATOR05",
  "HMO_INDICATOR06",
  "HMO_INDICATOR07",
  "HMO_INDICATOR08",
  "HMO_INDICATOR09",
  "HMO_INDICATOR10",
  "HMO_INDICATOR11",
  "HMO_INDICATOR12",
  "VALID_DATE_OF_DEATH_SWITCH",
  "DATE_OF_DEATH"
)

mbsf_data <- list(mbsf_2013, mbsf_2014, mbsf_2015, mbsf_2016, mbsf_2017, mbsf_2018, mbsf_2019, mbsf_2020)

for (a in 1:length(mbsf_data)) {
  mbsf_data[[a]] <- mbsf_data[[a]][, ..mbsf_needed_cols]
}

# rename last n columns in a dataset
rename_last <- function(data, how_many, new_names) {
  total_cols <- ncol(data)
  setnames(data, (total_cols - how_many + 1):(total_cols), new_names)
}


for (a in 1:length(mbsf_data)) {
  mbsf_data[[a]][, year := 2012 + a]
}



mbsf_data <- reduce(mbsf_data, function(x, y) {
  rbind(x, y)
}) %>% as.data.table()
```

```{r}
head(mbsf_data)
```

```{r}
mbsf_data_death_collapsed <- mbsf_data[!is.na(DATE_OF_DEATH)]

mbsf_data_death_collapsed$date_died <- mbsf_data_death_collapsed$DATE_OF_DEATH

mbsf_data <-
  left_join(mbsf_data,
    mbsf_data_death_collapsed[, .(
      DESY_SORT_KEY,
      date_died
    )],
    by = ("DESY_SORT_KEY")
  ) %>% as.data.table()

mbsf_data_death_collapsed <- mbsf_data[!is.na(VALID_DATE_OF_DEATH_SWITCH)]

mbsf_data_death_collapsed$date_died_valid <- mbsf_data_death_collapsed$VALID_DATE_OF_DEATH_SWITCH

mbsf_data <-
  left_join(mbsf_data,
    mbsf_data_death_collapsed[, .(
      DESY_SORT_KEY,
      date_died_valid
    )],
    by = ("DESY_SORT_KEY")
  ) %>% as.data.table()


head(mbsf_data)
```

```{r}
write_fst(mbsf_data, "/work/postresearch/Shared/Projects/Farbod/CaseMix/mbsf_data_long.fst")
```

<!-- #region tags=[] -->
### Read data


<!-- #endregion -->

```{r}
carrier_data_all_years <- read_fst(
  "/work/postresearch/Shared/Projects/Farbod/carrier_data_all_years.fst",
  as.data.table = T)
# mbsf_data = read_fst(
#  "/work/postresearch/Shared/Projects/Farbod/CaseMix/mbsf_data_long.fst", as.data.table = T)
# mbsf_data[,DESY_SORT_KEY := as.integer(DESY_SORT_KEY)]
```

```{r}
head(carrier_data_all_years)
#head(mbsf_data)
```

<!-- #region jp-MarkdownHeadingCollapsed=true tags=[] jp-MarkdownHeadingCollapsed=true jp-MarkdownHeadingCollapsed=true tags=[] -->
### Loading sample data (for pc)
<!-- #endregion -->

```{r}
sample_data <- readRDS(file = "sample_data.RDS")
```

```{r}
carrier_data_all_years <- sample_data[[1]]
outpatient_data_all_years <- sample_data[[2]]
inpatient_data_all_years <- sample_data[[3]]
mbsf_data <- read_fst("mbsf_data_long.fst", as.data.table = T)
revenue_center_outpatient_all_years <- sample_data[[5]]
outpatient_and_revenue_center_data <- sample_data[[6]]
```

<!-- #region tags=[] -->
### Patient yearly expenditures and use of services carrier

I will first create a function that adds conditions of interest to the data.

<!-- #endregion -->

#### Finding conditions for each claim line

```{r}
library(stringr)
```

```{r}
carrier_data_all_years[LINE_ICD_DGNS_VRSN_CD == 9 & fmatch(LINE_ICD_DGNS_CD, arthritis_icd_9_codes), is_arthritis:=T]
carrier_data_all_years[LINE_ICD_DGNS_VRSN_CD == 0 & fmatch(LINE_ICD_DGNS_CD, arthritis_icd_10_codes), is_arthritis:=T]

carrier_data_all_years[LINE_ICD_DGNS_VRSN_CD == 9 & fmatch(LINE_ICD_DGNS_CD, hypertension_icd_9_codes), is_hypertension:=T]
carrier_data_all_years[LINE_ICD_DGNS_VRSN_CD == 0 & fmatch(LINE_ICD_DGNS_CD, hypertension_icd_10_codes), is_hypertension:=T]

carrier_data_all_years[LINE_ICD_DGNS_VRSN_CD == 9 & fmatch(LINE_ICD_DGNS_CD, IHD_icd_9_codes), is_IHD:=T]
carrier_data_all_years[LINE_ICD_DGNS_VRSN_CD == 0 & fmatch(LINE_ICD_DGNS_CD, IHD_icd_10_codes), is_IHD:=T]

carrier_data_all_years[LINE_ICD_DGNS_VRSN_CD == 9 & fmatch(LINE_ICD_DGNS_CD, diabetes_icd_9_codes), is_diabetes:=T]
carrier_data_all_years[LINE_ICD_DGNS_VRSN_CD == 0 & fmatch(LINE_ICD_DGNS_CD, diabetes_icd_10_codes), is_diabetes:=T]

carrier_data_all_years[LINE_ICD_DGNS_VRSN_CD == 9 & fmatch(LINE_ICD_DGNS_CD, depression_icd_9_codes), is_depression:=T]
carrier_data_all_years[LINE_ICD_DGNS_VRSN_CD == 0 & fmatch(LINE_ICD_DGNS_CD, depression_icd_10_codes), is_depression:=T]


carrier_data_all_years[HCPCS_CD %in% office_visit_codes, is_office_visit:=T]
carrier_data_all_years[PRVDR_SPCLTY %in% primary_care_specialty_codes, is_by_primary_care_physician:=T]
```

```{r}
head(carrier_data_all_years[is_hypertension==T])
```

<!-- #region tags=[] -->
#### Summarizing patient data
I will now summarise the data for each patient.

<!-- #endregion -->

```{r}
summarise_carrier <- function(data, time_frame = 365) {
  data %>%
    group_by(DESY_SORT_KEY, year) %>%
    summarise(
      # tot_allowed_carrier = sum(na.rm = T, LINE_ALOWD_CHRG_AMT),

      # office_visit_count = sum(na.rm = T, is_office_visit),

      # office_visit_cost_carrier = sum(na.rm = T, LINE_ALOWD_CHRG_AMT * is_office_visit),
      distinct_clinicians = length(unique(PRF_PHYSN_NPI)),
      distinct_primary_care_physicians = length(.[is_by_primary_care_physician, unique(PRF_PHYSN_NPI)]),
      hypertension = sum(is_hypertension, na.rm = T) > 0,
      arthritis = sum(is_arthritis, na.rm = T) > 0,
      IHD = sum(is_IHD, na.rm = T) > 0,
      diabetes = sum(is_diabetes, na.rm = T) > 0,
      depression = sum(is_depression, na.rm = T) > 0,
      icd_9_pure = ifelse(prod(LINE_ICD_DGNS_VRSN_CD, na.rm = T) == 0, F, T),
      icd_10_pure = ifelse(sum(LINE_ICD_DGNS_VRSN_CD, na.rm = T) == 0, T, F),
    ) %>%
    as.data.table()
}


summary_patient_by_year <- summarise_carrier(carrier_data_all_years)
head(summary_patient_by_year)
```

```{r tags=c()}
add_patient_characteristics <- function(mbsf_data, summary_data) {
  mbsf_data <- unique(mbsf_data)
  require(dtplyr)
  require(lubridate)
  require(tidyverse)
  data <- left_join(summary_data, mbsf_data, by = c("DESY_SORT_KEY", "year")) %>% as.data.table()

  data %>%
    mutate(
      year_of_death = substr(date_died, 0, 4)
    ) %>%
    as.data.table()
}

summary_with_patient_characteristics <- add_patient_characteristics(mbsf_data, summary_patient_by_year)
head(summary_with_patient_characteristics)
```

```{r}
write.fst(summary_with_patient_characteristics, "summary_with_patient_characteristics_before_join.fst")
write.fst(summary_patient_by_year, "summary_patient_by_year_before_join.fst")
```

<!-- #region tags=[] toc-hr-collapsed=true -->
### Most common physicians for each patient

Now, we will find most common physicians and cardiologists for each patient.

<!-- #endregion -->

```{r}
summary_with_patient_characteristics <- read.fst("summary_with_patient_characteristics_before_join.fst", as.data.table = T)
summary_patient_by_year <- read.fst("summary_patient_by_year_before_join.fst", as.data.table = T)
```

```{r tags=c()}
# adding most common physicians
add_patient_NPI <- function(data, summary_data, time_frame = 365) {
  comorbidity_and_phys_data <-
    inner_join(data, summary_data[, c(
      "DESY_SORT_KEY", "year",
      "icd_9_pure",
      "icd_10_pure"
    )], by = c("DESY_SORT_KEY", "year")) %>%
    as.data.table()

  patient_NPI_count_finder <- function(data) {
    result <- data %>%
      mutate(is_office_visit = HCPCS_CD %in% office_visit_codes) %>%
      group_by(DESY_SORT_KEY, year, PRF_PHYSN_NPI) %>%
      summarise(n = sum(is_office_visit, na.rm = T)) %>%
      filter(n > 0) %>%
      arrange(.by_group = T, desc(n))
  }

  patient_NPI_counts <- patient_NPI_count_finder(comorbidity_and_phys_data)

  patient_NPI_counts <- left_join(patient_NPI_counts,
    distinct(data[, .(PRF_PHYSN_NPI, PRVDR_SPCLTY)]),
    by = "PRF_PHYSN_NPI"
  )

  find_most_common <- function(data) {
    data %>%
      group_by(DESY_SORT_KEY, year) %>%
      arrange(.by_group = T, desc(n)) %>%
      slice(1) %>%
      as.data.table()
  }

  find_most_common_by_specialty <- function(data, specialty_code) {
    data %>%
      filter(PRVDR_SPCLTY %in% specialty_code) %>%
      group_by(DESY_SORT_KEY, year) %>%
      arrange(.by_group = T, desc(n)) %>%
      slice(1) %>%
      as.data.table()
  }

  most_common_physician <- find_most_common(patient_NPI_counts)
  most_common_primary_care_physician <- find_most_common_by_specialty(patient_NPI_counts,
    specialty_code = c("01", "08", "11", "38")
  )
  most_common_physician <- data.frame(most_common_physician) %>%
    rename_with(~ paste0("most_common_physician_", .x))
  most_common_primary_care_physician <- data.frame(most_common_primary_care_physician) %>%
    rename_with(~ paste0("most_common_primary_care_physician_", .x))

  summary_data <- left_join(
    summary_data,
    most_common_physician,
    by = c("DESY_SORT_KEY" = "most_common_physician_DESY_SORT_KEY", "year" = "most_common_physician_year")
  )
  summary_data <- left_join(
    summary_data,
    most_common_primary_care_physician,
    by = c("DESY_SORT_KEY" = "most_common_primary_care_physician_DESY_SORT_KEY", "year" = "most_common_primary_care_physician_year")
  ) %>%
    as.data.table()
}

summary_with_npi <- add_patient_NPI(data = carrier_data_all_years, summary_data = summary_with_patient_characteristics)
head(summary_with_npi)
```

```{r}
write.fst(summary_with_npi, "summary_with_npi_before_join.fst")
```

<!-- #region tags=[] -->
## Physician integration status

Here, I will find which physicians are integrated.

<!-- #endregion -->

<!-- #region tags=[] -->
### A method of finding codes that are not exclusive to hospitals or non-hospital places
We can exclude these HCPCS codes and only include codes that are not exclusive to hospitals.
<!-- #endregion -->

```{r}
exclusive_hospital_code_finder <- function(data,
                                           threshold = 0.05,
                                           integrated_place_of_service_codes = c("19", "22"),
                                           all_place_of_service_codes = c("11", "19", "22")) {
  require(dtplyr)
  require(tidyverse)

  result <- data %>%
    filter(LINE_PLACE_OF_SRVC_CD %in% all_place_of_service_codes) %>%
    group_by(HCPCS_CD) %>%
    summarise(prp_in_facility = nrow(.[LINE_PLACE_OF_SRVC_CD %in% integrated_place_of_service_codes]) / n()) %>%
    as.data.table()

  exclusive_codes <- result[prp_in_facility < threshold | prp_in_facility > (1 - threshold), HCPCS_CD]


  return(exclusive_codes)
}

exclusive_hospital_codes <- exclusive_hospital_code_finder(carrier_data_all_years)
```

```{r jupyter={'outputs_hidden': True}, tags=c(), active="", eval=FALSE}
exclusive_hospital_codes
```

### A function to find integrated docs

```{r tags=c()}
# calculate and add physician integration data
# this only uses visits to see if a physician is integrated or not (codde list)

physician_integration_finder <- function(data,
                                         integrated_place_of_service_codes = c("19", "22"),
                                         all_place_of_service_codes = c("11", "19", "22"),
                                         # integration_threshold = 0.5,
                                         office_code_list = c(
                                           "99201",
                                           "99202",
                                           "99203",
                                           "99204",
                                           "99205",
                                           "99211",
                                           "99212",
                                           "99213",
                                           "99214",
                                           "99215"
                                         ),
                                         exclusive_hospital_codes) {
  require(dtplyr)
  require(tidyverse)

  # data = subset(data, HCPCS_CD %in% code_list)
  result <- data %>%
    mutate(
      is_facility = LINE_PLACE_OF_SRVC_CD %in% integrated_place_of_service_codes,
      is_all = LINE_PLACE_OF_SRVC_CD %in% all_place_of_service_codes,
      is_office_visit = HCPCS_CD %in% office_code_list,
      has_non_exclusive_code = HCPCS_CD %!in% exclusive_hospital_codes
    ) %>%
    group_by(PRF_PHYSN_NPI, year) %>%
    summarise(
      in_facility_visits_count = sum(is_facility * is_office_visit, na.rm = T),
      in_all_visits_count = sum(is_all * is_office_visit, na.rm = T),
      in_facility_non_exclusive_HCPCS_count = sum(is_facility * has_non_exclusive_code, na.rm = T),
      in_all_non_exclusive_HCPCS_count = sum(is_all * has_non_exclusive_code, na.rm = T),
      in_facility_count = sum(is_facility, na.rm = T),
      in_all_count = sum(is_all, na.rm = T)
    ) %>%
    mutate(
      in_facility_visits_prp = in_facility_visits_count / in_all_visits_count,
      in_facility_non_exclusive_HCPCS_prp = in_facility_non_exclusive_HCPCS_count / in_all_non_exclusive_HCPCS_count,
      in_facility_prp = in_facility_count / in_all_count
    ) %>%
    as.data.table()
}

physician_integration_stats <- physician_integration_finder(carrier_data_all_years, exclusive_hospital_codes = exclusive_hospital_codes)
```

```{r tags=c()}
tail(physician_integration_stats)
```

### Add integration status of physicians
This function will add the integration status of most common physicians to each patient's summary data.

```{r}
# summary_with_npi <- read.fst("./summary_with_npi_before_join.fst", as.data.table = T)

physician_integration_stats <- read.fst("./physician_integration_stats_before_join.fst", as.data.table = T)
```

```{r tags=c()}
# rename columns
rename_last <- function(data, how_many, new_names) {
  total_cols <- ncol(data)
  setnames(data, (total_cols - how_many + 1):(total_cols), new_names)
}
add_integration_status <- function(data, physician_integration_stats) {
  data_selected <- data[, c(
    "DESY_SORT_KEY",
    "year",
    "most_common_physician_PRF_PHYSN_NPI",
    "most_common_primary_care_physician_PRF_PHYSN_NPI"
  )]

  most_common_physician <- left_join(
    data_selected,
    physician_integration_stats,
    by = c(
      "most_common_physician_PRF_PHYSN_NPI" = "PRF_PHYSN_NPI", "year" = "year"
    )
  ) %>% as.data.table()

  most_common_physician <- most_common_physician[, -c("most_common_primary_care_physician_PRF_PHYSN_NPI")]

  rename_last(
    most_common_physician,
    ncol(physician_integration_stats) - 2,
    paste("most_common_physician_", colnames(physician_integration_stats)[3:ncol(physician_integration_stats)], sep = "")
  )


  most_common_primary_care <- left_join(
    data_selected,
    physician_integration_stats,
    by = c(
      "most_common_primary_care_physician_PRF_PHYSN_NPI" = "PRF_PHYSN_NPI", "year" = "year"
    )
  ) %>% as.data.table()

  most_common_primary_care <- most_common_primary_care[, -c("most_common_physician_PRF_PHYSN_NPI")]

  rename_last(
    most_common_primary_care,
    ncol(physician_integration_stats) - 2,
    paste("most_common_primary_care_physician_", colnames(physician_integration_stats)[3:ncol(physician_integration_stats)], sep = "")
  )

  physician_data <-
    full_join(most_common_physician[, -("most_common_physician_PRF_PHYSN_NPI")],
      most_common_primary_care[, -("most_common_primary_care_physician_PRF_PHYSN_NPI")],
      by = c("DESY_SORT_KEY", "year")
    )
  result <- full_join(data,
    physician_data,
    by = c("DESY_SORT_KEY", "year")
  ) %>%
    as.data.table()


  return(result)
}

summary_with_physician_integration_stats <- add_integration_status(
  data = summary_with_npi,
  physician_integration_stats = physician_integration_stats
)
```

```{r tags=c()}
head(summary_with_physician_integration_stats)
```

```{r}
write.fst(summary_with_physician_integration_stats, "summary_with_physician_integration_stats_new_new.fst")
```

```{r}
summary_with_npi[DESY_SORT_KEY == "100005325"]
```

<!-- #region tags=[] jp-MarkdownHeadingCollapsed=true tags=[] jp-MarkdownHeadingCollapsed=true tags=[] jp-MarkdownHeadingCollapsed=true jp-MarkdownHeadingCollapsed=true tags=[] -->
# Comparisons and analyses
<!-- #endregion -->

<!-- #region tags=[] -->
## Reading the patient and physician integration results
<!-- #endregion -->

```{r tags=c()}
yearly_calculations <-
  read_fst("calculation_results_new_new.fst", as.data.table = T)

yearly_calculations <- unique(yearly_calculations)
```

```{r}
yearly_calculations[DESY_SORT_KEY == "100005325"]
```

<!-- #region tags=[] -->
## Adding metropolitan status
I will add the metropolitan statuses of the patient counties using the USDA data
<!-- #endregion -->

```{r}
rural_urban_data <- readxl::read_xls("physician_data/ruralurbancodes2013.xls") %>% as.data.table()
head(rural_urban_data)
cross_walk_rural_urban <- read.csv(file = "physician_data/xwalk2018.csv") %>% as.data.table()
head(cross_walk_rural_urban)
```

```{r}
yearly_calculations[, SSACD := as.integer(paste(STATE_CODE, COUNTY_CODE, sep = ""))]
yearly_calculations <- left_join(yearly_calculations, cross_walk_rural_urban, by = "SSACD") %>%
  mutate(FIPS.County.Code = as.character(FIPS.County.Code)) %>%
  left_join(., rural_urban_data, by = c("FIPS.County.Code" = "FIPS")) %>%
  as.data.table()
yearly_calculations[, c("SSACD", "County.Name", "State.x", "FIPS.County.Code", "CBSA", "CBSA.Name", "State.y", "County_Name", "Population_2010", "Description") := NULL]
head(yearly_calculations)


# STATE_CODE	COUNTY_CODE	SEX_CODE	RACE_CODE
```

<!-- #region tags=[] -->
## Adding sex, race, and state names from codes
<!-- #endregion -->

```{r}
add_personal_details <- function(data) {
  require(tidyverse)
  require(dtplyr)
  require(lubridate)

  result <- data %>%
    # left_join(.,census_and_state_codes[,-1],by=c("STATE_CODE"="state_code"))%>%
    left_join(., race_codes, by = c("RACE_CODE" = "race_code")) %>%
    left_join(., sex_codes, by = c("SEX_CODE" = "sex_code")) %>%
    mutate(
      age_group = case_when(
        AGE < 75 & AGE > 64 ~ "65-74",
        AGE > 74 & AGE < 85 ~ "75-84",
        AGE > 84 ~ "85+"
      ),
      urban = (RUCC_2013 <= 3)
    ) %>%
    as.data.table()

  return(result)
}

# STATE_CODE	COUNTY_CODE	SEX_CODE	RACE_CODE
```

```{r}
yearly_calculations <- add_personal_details(yearly_calculations)
```

## Adding HMO indicator and buy in sums

```{r}
yearly_calculations[, HMO_INDICATOR_sum := sum(
  HMO_INDICATOR01 == 0,
  HMO_INDICATOR02 == 0,
  HMO_INDICATOR03 == 0,
  HMO_INDICATOR04 == 0,
  HMO_INDICATOR05 == 0,
  HMO_INDICATOR06 == 0,
  HMO_INDICATOR07 == 0,
  HMO_INDICATOR08 == 0,
  HMO_INDICATOR09 == 0,
  HMO_INDICATOR10 == 0,
  HMO_INDICATOR11 == 0,
  HMO_INDICATOR12 == 0,
  na.rm = T
), by = 1:nrow(yearly_calculations)]

yearly_calculations[, ENTITLEMENT_BUY_IN_IND_sum := sum(
  ENTITLEMENT_BUY_IN_IND01 %in% c("3", "C"),
  ENTITLEMENT_BUY_IN_IND02 %in% c("3", "C"),
  ENTITLEMENT_BUY_IN_IND03 %in% c("3", "C"),
  ENTITLEMENT_BUY_IN_IND04 %in% c("3", "C"),
  ENTITLEMENT_BUY_IN_IND05 %in% c("3", "C"),
  ENTITLEMENT_BUY_IN_IND06 %in% c("3", "C"),
  ENTITLEMENT_BUY_IN_IND07 %in% c("3", "C"),
  ENTITLEMENT_BUY_IN_IND08 %in% c("3", "C"),
  ENTITLEMENT_BUY_IN_IND09 %in% c("3", "C"),
  ENTITLEMENT_BUY_IN_IND10 %in% c("3", "C"),
  ENTITLEMENT_BUY_IN_IND11 %in% c("3", "C"),
  ENTITLEMENT_BUY_IN_IND12 %in% c("3", "C"),
  na.rm = T
), by = 1:nrow(yearly_calculations)]
```

## Adding months alive within the year of death

```{r}
yearly_calculations[, months_alive := as.numeric(substr(DATE_OF_DEATH, 5, 6))]
```

## Filtering the data for analysis

```{r}
length(yearly_calculations$DESY_SORT_KEY)
```

```{r}
data_for_modelling_filter <- function(data) {
  library(tidyverse)
  library(dtplyr)

  data %>%
    filter(STATE_CODE %!in% non_us_state_codes &

      AGE >= 65 &

      ((!is.na(months_alive) & HMO_INDICATOR_sum >= months_alive) |
        (is.na(months_alive) & HMO_INDICATOR_sum == 12)) &

      ((!is.na(months_alive) & ENTITLEMENT_BUY_IN_IND_sum >= months_alive) |
        (is.na(months_alive) & ENTITLEMENT_BUY_IN_IND_sum == 12))) %>%
    as.data.table()
}
```

```{r}
yearly_calculations <- data_for_modelling_filter(yearly_calculations)
```

```{r tags=c()}
length(yearly_calculations$DESY_SORT_KEY)
```

```{r}
write_fst(yearly_calculations, "yearly_calculations_cleaned_new.fst")
```

<!-- #region jp-MarkdownHeadingCollapsed=true tags=[] jp-MarkdownHeadingCollapsed=true tags=[] jp-MarkdownHeadingCollapsed=true -->
# Add MDPPAS
<!-- #endregion -->

<!-- #region tags=[] jp-MarkdownHeadingCollapsed=true -->
## Read from SAS file and convert to fst
<!-- #endregion -->

```{r tags=c()}
library(haven)
mdppas_data <- read_sas(
  data_file =
    "/work/postresearch/Shared/Data_raw/Medicare/MDPPAS/mdppas0819.sas7bdat"
)
```

```{r}
head(mdppas_data)
```

```{r}
write_fst(x = mdppas_data, path = "/work/postresearch/Shared/Data_raw/Medicare/MDPPAS/mdppas.fst", compress = 0)
```

<!-- #region tags=[] -->
## Read from fst
<!-- #endregion -->

```{r}
mdppas_data <-
  read_fst(path = "/work/postresearch/Shared/Data_raw/Medicare/MDPPAS/mdppas.fst", as.data.table = T)
```

```{r}
head(mdppas_data)
```

## Add to calculations and integration stats

```{r}
yearly_calculations <- read_fst("yearly_calculations_cleaned_new.fst", as.data.table = T)
```

```{r}
yearly_calculations <-
  left_join(yearly_calculations, mdppas_data,
    by = c("most_common_primary_care_physician_PRF_PHYSN_NPI" = "npi", "year" = "year")
  ) %>% as.data.table()
head(yearly_calculations)
```

```{r}
write_fst(x = yearly_calculations, "yearly_calculations_cleaned_with_mdppas_new.fst", compress = 0)
```

```{r}
physician_integration_stats <- read.fst("./physician_integration_stats_before_join.fst", as.data.table = T)
```

```{r}
physician_integration_stats <-
  left_join(physician_integration_stats, mdppas_data,
    by = c("PRF_PHYSN_NPI" = "npi", "year" = "year")
  ) %>% as.data.table()
```

```{r}
physician_integration_stats[PRF_PHYSN_NPI == 1770514119]
```

<!-- #region tags=[] jp-MarkdownHeadingCollapsed=true -->
# Finding changes in physician patient pools
<!-- #endregion -->

```{r}
physician_integration_change_finder <- function(data, integration_threshold = 0.75, independece_threshold = 0.75) {
  require(tidyverse)
  require(dtplyr)

  result <- data %>%
    mutate(
      integrated = (in_facility_non_exclusive_HCPCS_prp >= integration_threshold | vikeyword == 1)
    ) %>%
    group_by(PRF_PHYSN_NPI) %>%
    mutate(
      integration_change =
        case_when(
          integrated == T & lag(integrated) == F ~ "newly_integrated",
          integrated == F & lag(integrated) == T ~ "newly_disintegrated",
          is.na(integrated) & lag(integrated) == F ~ "remained_independent",
          integrated == F & lag(integrated) == F ~ "remained_independent",
          integrated == T & lag(integrated) == T ~ "remained_integrated",
          integrated == T & is.na(lag(integrated)) & lag(integrated, 2) == T ~ "remained_integrated",
          integrated == T & is.na(lag(integrated)) & lag(integrated, 2) == F ~ "newly_integrated",
          is.na(integrated) & lag(integrated) == T ~ "remained_integrated",
          year == 2013 & integrated == T ~ "remained_integrated",
          year == 2013 & integrated == F ~ "remained_independent"
        ),
    ) %>%
    group_by(PRF_PHYSN_NPI) %>%
    mutate(
      sum_integration_changes = sum(integration_change %in% c("newly_integrated", "newly_disintegrated"), na.rm = T),
      integrated_once_and_stayed =
        sum(integration_change == "newly_disintegrated", na.rm = T) == 0 &
          sum(integration_change == "newly_integrated", na.rm = T) == 1,
      never_integrated =
        sum(integration_change == "newly_integrated", na.rm = T) == 0 &
          sum(integration_change == "remained_integrated", na.rm = T) == 0 &
          sum(integration_change == "newly_disintegrated", na.rm = T) == 0
    ) %>%
    group_by(PRF_PHYSN_NPI) %>%
    mutate(
      year_integrated = case_when(integration_change == "newly_integrated" & integrated_once_and_stayed == T ~ year)
    ) %>%
    group_by(PRF_PHYSN_NPI) %>%
    mutate(
      year_integrated = year_integrated[which(!is.na(year_integrated))]
    ) %>%
    mutate(years_from_integration = year - year_integrated) %>%
    as.data.table()
}
```

```{r}
physician_integration_stats_changes <- physician_integration_change_finder(physician_integration_stats)
```

```{r}
yearly_calculations <- read.fst("yearly_calculations_cleaned_with_mdppas_new.fst", as.data.table = T)
```

```{r tags=c()}
yearly_calculations <- left_join(
  yearly_calculations,
  physician_integration_stats_changes[, .(PRF_PHYSN_NPI, year, integrated, integration_change, sum_integration_changes, integrated_once_and_stayed, never_integrated, year_integrated, years_from_integration)],
  by = c("most_common_primary_care_physician_PRF_PHYSN_NPI" = "PRF_PHYSN_NPI", "year" = "year")
) %>% as.data.table()
```

```{r}
rename_last <- function(data, how_many, new_names) {
  total_cols <- ncol(data)
  setnames(data, (total_cols - how_many + 1):(total_cols), new_names)
}

rename_last(yearly_calculations, 7, paste("most_common_primary_care_physician_", colnames(yearly_calculations[, (ncol(yearly_calculations) - 6):ncol(yearly_calculations)]), sep = ""))
```

```{r tags=c()}
yearly_calculations <- yearly_calculations %>%
  group_by(DESY_SORT_KEY) %>%
  mutate(
    most_common_primary_care_physician_changed = case_when(
      most_common_primary_care_physician_PRF_PHYSN_NPI != lag(most_common_primary_care_physician_PRF_PHYSN_NPI) ~ T,
      most_common_primary_care_physician_PRF_PHYSN_NPI == lag(most_common_primary_care_physician_PRF_PHYSN_NPI) ~ F,
      year == 2013 ~ F
    )
  ) %>%
  as.data.table()
```

```{r}
head(yearly_calculations)
```

## Adding last year's physician's integration status

```{r}
yearly_calculations <- yearly_calculations %>%
  group_by(DESY_SORT_KEY) %>%
  arrange(year) %>%
  mutate(
    last_year_most_common_primary_care_physician_PRF_PHYSN_NPI =
      lag(most_common_primary_care_physician_PRF_PHYSN_NPI, 1)
  ) %>%
  as.data.table()

yearly_calculations[DESY_SORT_KEY == "100005325"]
```

```{r tags=c()}
yearly_calculations <- left_join(
  yearly_calculations,
  physician_integration_stats_changes[, .(PRF_PHYSN_NPI, year, integrated, integration_change, sum_integration_changes, integrated_once_and_stayed, never_integrated, year_integrated, years_from_integration)],
  by = c("last_year_most_common_primary_care_physician_PRF_PHYSN_NPI" = "PRF_PHYSN_NPI", "year" = "year")
) %>% as.data.table()
```

```{r}
rename_last <- function(data, how_many, new_names) {
  total_cols <- ncol(data)
  setnames(data, (total_cols - how_many + 1):(total_cols), new_names)
}

rename_last(yearly_calculations, 7, paste("last_year_most_common_primary_care_physician_", colnames(yearly_calculations[, (ncol(yearly_calculations) - 6):ncol(yearly_calculations)]), sep = ""))
```

```{r}
head(yearly_calculations)
```

```{r}
write_fst(x = yearly_calculations, "yearly_calculations_cleaned_with_mdppas_with_physician_changes_new.fst", compress = 0)
```

```{r}
yearly_calculations = read_fst( "yearly_calculations_cleaned_with_mdppas_with_physician_changes_new.fst") %>% as.data.table()
```

```{r}
yearly_calculations[DESY_SORT_KEY == "100000015"]
```

```{r}
temp=yearly_calculations %>% 
group_by(DESY_SORT_KEY) %>%
arrange(year)%>%
mutate(arthritis=case_when(lag(arthritis)==T ~ T, T ~ arthritis),
       hypertension=case_when(lag(hypertension)==T ~ T, T ~ hypertension),
       IHD=case_when(lag(IHD)==T ~ T, T ~ IHD),
       diabetes=case_when(lag(diabetes)==T ~ T, T ~ diabetes)
      )%>%
as.data.table()
```

```{r}
temp[DESY_SORT_KEY == "100000015"]
```

```{r}
yearly_calculations <- temp
```

```{r}
write.fst(yearly_calculations, "yearly_calculations_cleaned_with_mdppas_with_physician_changes__with_lag_repeat_new.fst")
```

<!-- #region tags=[] -->
# Adding claim level file
<!-- #endregion -->

<!-- #region jp-MarkdownHeadingCollapsed=true tags=[] jp-MarkdownHeadingCollapsed=true jp-MarkdownHeadingCollapsed=true tags=[] jp-MarkdownHeadingCollapsed=true tags=[] jp-MarkdownHeadingCollapsed=true -->
## Reading the CSVs
<!-- #endregion -->

```{r tags=c(), jupyter={'outputs_hidden': {'outputs_hidden': True}}}
claim_carrier_2013 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/car_claimsj_lds_5_2013.csv", num_threads = numcores) %>% as.data.table()
claim_carrier_2014 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/car_claimsj_lds_5_2014.csv", num_threads = numcores) %>% as.data.table()
claim_carrier_2015 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/car_claimsj_lds_5_2015.csv", num_threads = numcores) %>% as.data.table()
claim_carrier_2016 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/car_claimsk_lds_5_2016.csv", num_threads = numcores) %>% as.data.table()
claim_carrier_2017 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/car_claimsk_lds_5_2017.csv", num_threads = numcores) %>% as.data.table()
claim_carrier_2018 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/car_claimsk_lds_5_2018.csv", num_threads = numcores) %>% as.data.table()
claim_carrier_2019 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/car_claimsk_lds_5_2019.csv", num_threads = numcores) %>% as.data.table()
claim_carrier_2020 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/car_claimsk_lds_5_2020.csv", num_threads = numcores) %>% as.data.table()

claim_inpatient_2013 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/inp_claimsj_lds_5_2013.csv", num_threads = numcores) %>% as.data.table()
claim_inpatient_2014 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/inp_claimsj_lds_5_2014.csv", num_threads = numcores) %>% as.data.table()
claim_inpatient_2015 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/inp_claimsj_lds_5_2015.csv", num_threads = numcores) %>% as.data.table()
claim_inpatient_2016 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/inp_claimsk_lds_5_2016.csv", num_threads = numcores) %>% as.data.table()
claim_inpatient_2017 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/inp_claimsk_lds_5_2017.csv", num_threads = numcores) %>% as.data.table()
claim_inpatient_2018 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/inp_claimsk_lds_5_2018.csv", num_threads = numcores) %>% as.data.table()
claim_inpatient_2019 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/inp_claimsk_lds_5_2019.csv", num_threads = numcores) %>% as.data.table()
claim_inpatient_2020 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/inp_claimsk_lds_5_2020.csv", num_threads = numcores) %>% as.data.table()

claim_outpatient_2013 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/out_claimsj_lds_5_2013.csv", num_threads = numcores) %>% as.data.table()
claim_outpatient_2014 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/out_claimsj_lds_5_2014.csv", num_threads = numcores) %>% as.data.table()
claim_outpatient_2015 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/out_claimsj_lds_5_2015.csv", num_threads = numcores) %>% as.data.table()
claim_outpatient_2016 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/out_claimsk_lds_5_2016.csv", num_threads = numcores) %>% as.data.table()
claim_outpatient_2017 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/out_claimsk_lds_5_2017.csv", num_threads = numcores) %>% as.data.table()
claim_outpatient_2018 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/out_claimsk_lds_5_2018.csv", num_threads = numcores) %>% as.data.table()
claim_outpatient_2019 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/out_claimsk_lds_5_2019.csv", num_threads = numcores) %>% as.data.table()
claim_outpatient_2020 <- vroom(file = "/work/postresearch/Shared/Data_raw/Medicare/Claims/CSV/out_claimsk_lds_5_2020.csv", num_threads = numcores) %>% as.data.table()
```

```{r}
colnames_claim_carrier_2011_2015 <-
  c("DESY_SORT_KEY", "CLAIM_NO", "CLM_THRU_DT", "NCH_NEAR_LINE_REC_IDENT_CD", "NCH_CLM_TYPE_CD", "CLM_DISP_CD", "CARR_NUM", "CARR_CLM_PMT_DNL_CD", "CLM_PMT_AMT", "CARR_CLM_PRMRY_PYR_PD_AMT", "RFR_PHYSN_UPIN", "RFR_PHYSN_NPI", "CARR_CLM_PRVDR_ASGNMT_IND_SW", "PROV_PMT", "BENE_PMT", "SBMTCHRG", "ALOWCHRG", "DEDAPPLY", "HCPCS_YR", "CARR_CLM_RFRNG_PIN_NUM", "PRNCPAL_DGNS_CD", "PRNCPAL_DGNS_VRSN_CD", "ICD_DGNS_CD1", "ICD_DGNS_VRSN_CD1", "ICD_DGNS_CD2", "ICD_DGNS_VRSN_CD2", "ICD_DGNS_CD3", "ICD_DGNS_VRSN_CD3", "ICD_DGNS_CD4", "ICD_DGNS_VRSN_CD4", "ICD_DGNS_CD5", "ICD_DGNS_VRSN_CD5", "ICD_DGNS_CD6", "ICD_DGNS_VRSN_CD6", "ICD_DGNS_CD7", "ICD_DGNS_VRSN_CD7", "ICD_DGNS_CD8", "ICD_DGNS_VRSN_CD8", "ICD_DGNS_CD9", "ICD_DGNS_VRSN_CD9", "ICD_DGNS_CD10", "ICD_DGNS_VRSN_CD10", "ICD_DGNS_CD11", "ICD_DGNS_VRSN_CD11", "ICD_DGNS_CD12", "ICD_DGNS_VRSN_CD12", "DOB_DT", "GNDR_CD", "BENE_RACE_CD", "BENE_CNTY_CD", "BENE_STATE_CD", "CWF_BENE_MDCR_STUS_CD")

colnames_claim_carrier_2016_2020 <-
  c("DESY_SORT_KEY", "CLAIM_NO", "CLM_THRU_DT", "NCH_NEAR_LINE_REC_IDENT_CD", "NCH_CLM_TYPE_CD", "CLM_DISP_CD", "CARR_NUM", "CARR_CLM_PMT_DNL_CD", "CLM_PMT_AMT", "CARR_CLM_PRMRY_PYR_PD_AMT", "RFR_PHYSN_UPIN", "RFR_PHYSN_NPI", "CARR_CLM_PRVDR_ASGNMT_IND_SW", "NCH_CLM_PRVDR_PMT_AMT", "NCH_CLM_BENE_PMT_AMT", "NCH_CARR_CLM_SBMTD_CHRG_AMT", "NCH_CARR_CLM_ALOWD_AMT", "CARR_CLM_CASH_DDCTBL_APLD_AMT", "CARR_CLM_HCPCS_YR_CD", "CARR_CLM_RFRNG_PIN_NUM", "PRNCPAL_DGNS_CD", "PRNCPAL_DGNS_VRSN_CD", "ICD_DGNS_CD1", "ICD_DGNS_VRSN_CD1", "ICD_DGNS_CD2", "ICD_DGNS_VRSN_CD2", "ICD_DGNS_CD3", "ICD_DGNS_VRSN_CD3", "ICD_DGNS_CD4", "ICD_DGNS_VRSN_CD4", "ICD_DGNS_CD5", "ICD_DGNS_VRSN_CD5", "ICD_DGNS_CD6", "ICD_DGNS_VRSN_CD6", "ICD_DGNS_CD7", "ICD_DGNS_VRSN_CD7", "ICD_DGNS_CD8", "ICD_DGNS_VRSN_CD8", "ICD_DGNS_CD9", "ICD_DGNS_VRSN_CD9", "ICD_DGNS_CD10", "ICD_DGNS_VRSN_CD10", "ICD_DGNS_CD11", "ICD_DGNS_VRSN_CD11", "ICD_DGNS_CD12", "ICD_DGNS_VRSN_CD12", "DOB_DT", "GNDR_CD", "BENE_RACE_CD", "BENE_CNTY_CD", "BENE_STATE_CD", "CWF_BENE_MDCR_STUS_CD", "CLM_BENE_PD_AMT", "CPO_PRVDR_NUM", "CPO_ORG_NPI_NUM", "CARR_CLM_BLG_NPI_NUM", "ACO_ID_NUM")

colnames_claim_inpatient_2011_2015 <-
  c("DESY_SORT_KEY", "CLAIM_NO", "PRVDR_NUM", "CLM_THRU_DT", "NCH_NEAR_LINE_REC_IDENT_CD", "NCH_CLM_TYPE_CD", "CLAIM_QUERY_CODE", "CLM_FAC_TYPE_CD", "CLM_SRVC_CLSFCTN_TYPE_CD", "CLM_FREQ_CD", "FI_NUM", "CLM_MDCR_NON_PMT_RSN_CD", "CLM_PMT_AMT", "NCH_PRMRY_PYR_CLM_PD_AMT", "NCH_PRMRY_PYR_CD", "FI_CLM_ACTN_CD", "PRVDR_STATE_CD", "ORG_NPI_NUM", "AT_PHYSN_UPIN", "AT_PHYSN_NPI", "OP_PHYSN_UPIN", "OP_PHYSN_NPI", "OT_PHYSN_UPIN", "OT_PHYSN_NPI", "CLM_MCO_PD_SW", "PTNT_DSCHRG_STUS_CD", "CLM_PPS_IND_CD", "CLM_TOT_CHRG_AMT", "CLM_ADMSN_DT", "CLM_IP_ADMSN_TYPE_CD", "CLM_SRC_IP_ADMSN_CD", "NCH_PTNT_STATUS_IND_CD", "CLM_PASS_THRU_PER_DIEM_AMT", "NCH_BENE_IP_DDCTBL_AMT", "NCH_BENE_PTA_COINSRNC_LBLTY_AM", "NCH_BENE_BLOOD_DDCTBL_LBLTY_AM", "NCH_PROFNL_CMPNT_CHRG_AMT", "NCH_IP_NCVRD_CHRG_AMT", "CLM_TOT_PPS_CPTL_AMT", "CLM_PPS_CPTL_FSP_AMT", "CLM_PPS_CPTL_OUTLIER_AMT", "CLM_PPS_CPTL_DSPRPRTNT_SHR_AMT", "CLM_PPS_CPTL_IME_AMT", "CLM_PPS_CPTL_EXCPTN_AMT", "CLM_PPS_OLD_CPTL_HLD_HRMLS_AMT", "CLM_PPS_CPTL_DRG_WT_NUM", "CLM_UTLZTN_DAY_CNT", "BENE_TOT_COINSRNC_DAYS_CNT", "BENE_LRD_USED_CNT", "CLM_NON_UTLZTN_DAYS_CNT", "NCH_BLOOD_PNTS_FRNSHD_QTY", "NCH_VRFD_NCVRD_STAY_FROM_DT", "NCH_VRFD_NCVRD_STAY_THRU_DT", "NCH_BENE_MDCR_BNFTS_EXHTD_DT_I", "NCH_BENE_DSCHRG_DT", "CLM_DRG_CD", "CLM_DRG_OUTLIER_STAY_CD", "NCH_DRG_OUTLIER_APRVD_PMT_AMT", "ADMTG_DGNS_CD", "ADMTG_DGNS_VRSN_CD", "PRNCPAL_DGNS_CD", "PRNCPAL_DGNS_VRSN_CD", "ICD_DGNS_CD1", "ICD_DGNS_VRSN_CD1", "CLM_POA_IND_SW1", "ICD_DGNS_CD2", "ICD_DGNS_VRSN_CD2", "CLM_POA_IND_SW2", "ICD_DGNS_CD3", "ICD_DGNS_VRSN_CD3", "CLM_POA_IND_SW3", "ICD_DGNS_CD4", "ICD_DGNS_VRSN_CD4", "CLM_POA_IND_SW4", "ICD_DGNS_CD5", "ICD_DGNS_VRSN_CD5", "CLM_POA_IND_SW5", "ICD_DGNS_CD6", "ICD_DGNS_VRSN_CD6", "CLM_POA_IND_SW6", "ICD_DGNS_CD7", "ICD_DGNS_VRSN_CD7", "CLM_POA_IND_SW7", "ICD_DGNS_CD8", "ICD_DGNS_VRSN_CD8", "CLM_POA_IND_SW8", "ICD_DGNS_CD9", "ICD_DGNS_VRSN_CD9", "CLM_POA_IND_SW9", "ICD_DGNS_CD10", "ICD_DGNS_VRSN_CD10", "CLM_POA_IND_SW10", "ICD_DGNS_CD11", "ICD_DGNS_VRSN_CD11", "CLM_POA_IND_SW11", "ICD_DGNS_CD12", "ICD_DGNS_VRSN_CD12", "CLM_POA_IND_SW12", "ICD_DGNS_CD13", "ICD_DGNS_VRSN_CD13", "CLM_POA_IND_SW13", "ICD_DGNS_CD14", "ICD_DGNS_VRSN_CD14", "CLM_POA_IND_SW14", "ICD_DGNS_CD15", "ICD_DGNS_VRSN_CD15", "CLM_POA_IND_SW15", "ICD_DGNS_CD16", "ICD_DGNS_VRSN_CD16", "CLM_POA_IND_SW16", "ICD_DGNS_CD17", "ICD_DGNS_VRSN_CD17", "CLM_POA_IND_SW17", "ICD_DGNS_CD18", "ICD_DGNS_VRSN_CD18", "CLM_POA_IND_SW18", "ICD_DGNS_CD19", "ICD_DGNS_VRSN_CD19", "CLM_POA_IND_SW19", "ICD_DGNS_CD20", "ICD_DGNS_VRSN_CD20", "CLM_POA_IND_SW20", "ICD_DGNS_CD21", "ICD_DGNS_VRSN_CD21", "CLM_POA_IND_SW21", "ICD_DGNS_CD22", "ICD_DGNS_VRSN_CD22", "CLM_POA_IND_SW22", "ICD_DGNS_CD23", "ICD_DGNS_VRSN_CD23", "CLM_POA_IND_SW23", "ICD_DGNS_CD24", "ICD_DGNS_VRSN_CD24", "CLM_POA_IND_SW24", "ICD_DGNS_CD25", "ICD_DGNS_VRSN_CD25", "CLM_POA_IND_SW25", "FST_DGNS_E_CD", "FST_DGNS_E_VRSN_CD", "ICD_DGNS_E_CD1", "ICD_DGNS_E_VRSN_CD1", "CLM_E_POA_IND_SW1", "ICD_DGNS_E_CD2", "ICD_DGNS_E_VRSN_CD2", "CLM_E_POA_IND_SW2", "ICD_DGNS_E_CD3", "ICD_DGNS_E_VRSN_CD3", "CLM_E_POA_IND_SW3", "ICD_DGNS_E_CD4", "ICD_DGNS_E_VRSN_CD4", "CLM_E_POA_IND_SW4", "ICD_DGNS_E_CD5", "ICD_DGNS_E_VRSN_CD5", "CLM_E_POA_IND_SW5", "ICD_DGNS_E_CD6", "ICD_DGNS_E_VRSN_CD6", "CLM_E_POA_IND_SW6", "ICD_DGNS_E_CD7", "ICD_DGNS_E_VRSN_CD7", "CLM_E_POA_IND_SW7", "ICD_DGNS_E_CD8", "ICD_DGNS_E_VRSN_CD8", "CLM_E_POA_IND_SW8", "ICD_DGNS_E_CD9", "ICD_DGNS_E_VRSN_CD9", "CLM_E_POA_IND_SW9", "ICD_DGNS_E_CD10", "ICD_DGNS_E_VRSN_CD10", "CLM_E_POA_IND_SW10", "ICD_DGNS_E_CD11", "ICD_DGNS_E_VRSN_CD11", "CLM_E_POA_IND_SW11", "ICD_DGNS_E_CD12", "ICD_DGNS_E_VRSN_CD12", "CLM_E_POA_IND_SW12", "ICD_PRCDR_CD1", "ICD_PRCDR_VRSN_CD1", "PRCDR_DT1", "ICD_PRCDR_CD2", "ICD_PRCDR_VRSN_CD2", "PRCDR_DT2", "ICD_PRCDR_CD3", "ICD_PRCDR_VRSN_CD3", "PRCDR_DT3", "ICD_PRCDR_CD4", "ICD_PRCDR_VRSN_CD4", "PRCDR_DT4", "ICD_PRCDR_CD5", "ICD_PRCDR_VRSN_CD5", "PRCDR_DT5", "ICD_PRCDR_CD6", "ICD_PRCDR_VRSN_CD6", "PRCDR_DT6", "ICD_PRCDR_CD7", "ICD_PRCDR_VRSN_CD7", "PRCDR_DT7", "ICD_PRCDR_CD8", "ICD_PRCDR_VRSN_CD8", "PRCDR_DT8", "ICD_PRCDR_CD9", "ICD_PRCDR_VRSN_CD9", "PRCDR_DT9", "ICD_PRCDR_CD10", "ICD_PRCDR_VRSN_CD10", "PRCDR_DT10", "ICD_PRCDR_CD11", "ICD_PRCDR_VRSN_CD11", "PRCDR_DT11", "ICD_PRCDR_CD12", "ICD_PRCDR_VRSN_CD12", "PRCDR_DT12", "ICD_PRCDR_CD13", "ICD_PRCDR_VRSN_CD13", "PRCDR_DT13", "ICD_PRCDR_CD14", "ICD_PRCDR_VRSN_CD14", "PRCDR_DT14", "ICD_PRCDR_CD15", "ICD_PRCDR_VRSN_CD15", "PRCDR_DT15", "ICD_PRCDR_CD16", "ICD_PRCDR_VRSN_CD16", "PRCDR_DT16", "ICD_PRCDR_CD17", "ICD_PRCDR_VRSN_CD17", "PRCDR_DT17", "ICD_PRCDR_CD18", "ICD_PRCDR_VRSN_CD18", "PRCDR_DT18", "ICD_PRCDR_CD19", "ICD_PRCDR_VRSN_CD19", "PRCDR_DT19", "ICD_PRCDR_CD20", "ICD_PRCDR_VRSN_CD20", "PRCDR_DT20", "ICD_PRCDR_CD21", "ICD_PRCDR_VRSN_CD21", "PRCDR_DT21", "ICD_PRCDR_CD22", "ICD_PRCDR_VRSN_CD22", "PRCDR_DT22", "ICD_PRCDR_CD23", "ICD_PRCDR_VRSN_CD23", "PRCDR_DT23", "ICD_PRCDR_CD24", "ICD_PRCDR_VRSN_CD24", "PRCDR_DT24", "ICD_PRCDR_CD25", "ICD_PRCDR_VRSN_CD25", "PRCDR_DT25", "DOB_DT", "GNDR_CD", "BENE_RACE_CD", "BENE_CNTY_CD", "BENE_STATE_CD", "CWF_BENE_MDCR_STUS_CD")

colnames_claim_inpatient_2016_2020 <-
  c("DESY_SORT_KEY", "CLAIM_NO", "PRVDR_NUM", "CLM_THRU_DT", "NCH_NEAR_LINE_REC_IDENT_CD", "NCH_CLM_TYPE_CD", "CLAIM_QUERY_CODE", "CLM_FAC_TYPE_CD", "CLM_SRVC_CLSFCTN_TYPE_CD", "CLM_FREQ_CD", "FI_NUM", "CLM_MDCR_NON_PMT_RSN_CD", "CLM_PMT_AMT", "NCH_PRMRY_PYR_CLM_PD_AMT", "NCH_PRMRY_PYR_CD", "FI_CLM_ACTN_CD", "PRVDR_STATE_CD", "ORG_NPI_NUM", "AT_PHYSN_UPIN", "AT_PHYSN_NPI", "AT_PHYSN_SPCLTY_CD", "OP_PHYSN_UPIN", "OP_PHYSN_NPI", "OP_PHYSN_SPCLTY_CD", "OT_PHYSN_UPIN", "OT_PHYSN_NPI", "OT_PHYSN_SPCLTY_CD", "RNDRNG_PHYSN_NPI", "RNDRNG_PHYSN_SPCLTY_CD", "CLM_MCO_PD_SW", "PTNT_DSCHRG_STUS_CD", "CLM_PPS_IND_CD", "CLM_TOT_CHRG_AMT", "CLM_ADMSN_DT", "CLM_IP_ADMSN_TYPE_CD", "CLM_SRC_IP_ADMSN_CD", "NCH_PTNT_STATUS_IND_CD", "CLM_PASS_THRU_PER_DIEM_AMT", "NCH_BENE_IP_DDCTBL_AMT", "NCH_BENE_PTA_COINSRNC_LBLTY_AM", "NCH_BENE_BLOOD_DDCTBL_LBLTY_AM", "NCH_PROFNL_CMPNT_CHRG_AMT", "NCH_IP_NCVRD_CHRG_AMT", "CLM_TOT_PPS_CPTL_AMT", "CLM_PPS_CPTL_FSP_AMT", "CLM_PPS_CPTL_OUTLIER_AMT", "CLM_PPS_CPTL_DSPRPRTNT_SHR_AMT", "CLM_PPS_CPTL_IME_AMT", "CLM_PPS_CPTL_EXCPTN_AMT", "CLM_PPS_OLD_CPTL_HLD_HRMLS_AMT", "CLM_PPS_CPTL_DRG_WT_NUM", "CLM_UTLZTN_DAY_CNT", "BENE_TOT_COINSRNC_DAYS_CNT", "BENE_LRD_USED_CNT", "CLM_NON_UTLZTN_DAYS_CNT", "NCH_BLOOD_PNTS_FRNSHD_QTY", "NCH_VRFD_NCVRD_STAY_FROM_DT", "NCH_VRFD_NCVRD_STAY_THRU_DT", "NCH_BENE_MDCR_BNFTS_EXHTD_DT_I", "NCH_BENE_DSCHRG_DT", "CLM_DRG_CD", "CLM_DRG_OUTLIER_STAY_CD", "NCH_DRG_OUTLIER_APRVD_PMT_AMT", "ADMTG_DGNS_CD", "PRNCPAL_DGNS_CD", "ICD_DGNS_CD1", "CLM_POA_IND_SW1", "ICD_DGNS_CD2", "CLM_POA_IND_SW2", "ICD_DGNS_CD3", "CLM_POA_IND_SW3", "ICD_DGNS_CD4", "CLM_POA_IND_SW4", "ICD_DGNS_CD5", "CLM_POA_IND_SW5", "ICD_DGNS_CD6", "CLM_POA_IND_SW6", "ICD_DGNS_CD7", "CLM_POA_IND_SW7", "ICD_DGNS_CD8", "CLM_POA_IND_SW8", "ICD_DGNS_CD9", "CLM_POA_IND_SW9", "ICD_DGNS_CD10", "CLM_POA_IND_SW10", "ICD_DGNS_CD11", "CLM_POA_IND_SW11", "ICD_DGNS_CD12", "CLM_POA_IND_SW12", "ICD_DGNS_CD13", "CLM_POA_IND_SW13", "ICD_DGNS_CD14", "CLM_POA_IND_SW14", "ICD_DGNS_CD15", "CLM_POA_IND_SW15", "ICD_DGNS_CD16", "CLM_POA_IND_SW16", "ICD_DGNS_CD17", "CLM_POA_IND_SW17", "ICD_DGNS_CD18", "CLM_POA_IND_SW18", "ICD_DGNS_CD19", "CLM_POA_IND_SW19", "ICD_DGNS_CD20", "CLM_POA_IND_SW20", "ICD_DGNS_CD21", "CLM_POA_IND_SW21", "ICD_DGNS_CD22", "CLM_POA_IND_SW22", "ICD_DGNS_CD23", "CLM_POA_IND_SW23", "ICD_DGNS_CD24", "CLM_POA_IND_SW24", "ICD_DGNS_CD25", "CLM_POA_IND_SW25", "FST_DGNS_E_CD", "ICD_DGNS_E_CD1", "CLM_E_POA_IND_SW1", "ICD_DGNS_E_CD2", "CLM_E_POA_IND_SW2", "ICD_DGNS_E_CD3", "CLM_E_POA_IND_SW3", "ICD_DGNS_E_CD4", "CLM_E_POA_IND_SW4", "ICD_DGNS_E_CD5", "CLM_E_POA_IND_SW5", "ICD_DGNS_E_CD6", "CLM_E_POA_IND_SW6", "ICD_DGNS_E_CD7", "CLM_E_POA_IND_SW7", "ICD_DGNS_E_CD8", "CLM_E_POA_IND_SW8", "ICD_DGNS_E_CD9", "CLM_E_POA_IND_SW9", "ICD_DGNS_E_CD10", "CLM_E_POA_IND_SW10", "ICD_DGNS_E_CD11", "CLM_E_POA_IND_SW11", "ICD_DGNS_E_CD12", "CLM_E_POA_IND_SW12", "ICD_PRCDR_CD1", "PRCDR_DT1", "ICD_PRCDR_CD2", "PRCDR_DT2", "ICD_PRCDR_CD3", "PRCDR_DT3", "ICD_PRCDR_CD4", "PRCDR_DT4", "ICD_PRCDR_CD5", "PRCDR_DT5", "ICD_PRCDR_CD6", "PRCDR_DT6", "ICD_PRCDR_CD7", "PRCDR_DT7", "ICD_PRCDR_CD8", "PRCDR_DT8", "ICD_PRCDR_CD9", "PRCDR_DT9", "ICD_PRCDR_CD10", "PRCDR_DT10", "ICD_PRCDR_CD11", "PRCDR_DT11", "ICD_PRCDR_CD12", "PRCDR_DT12", "ICD_PRCDR_CD13", "PRCDR_DT13", "ICD_PRCDR_CD14", "PRCDR_DT14", "ICD_PRCDR_CD15", "PRCDR_DT15", "ICD_PRCDR_CD16", "PRCDR_DT16", "ICD_PRCDR_CD17", "PRCDR_DT17", "ICD_PRCDR_CD18", "PRCDR_DT18", "ICD_PRCDR_CD19", "PRCDR_DT19", "ICD_PRCDR_CD20", "PRCDR_DT20", "ICD_PRCDR_CD21", "PRCDR_DT21", "ICD_PRCDR_CD22", "PRCDR_DT22", "ICD_PRCDR_CD23", "PRCDR_DT23", "ICD_PRCDR_CD24", "PRCDR_DT24", "ICD_PRCDR_CD25", "PRCDR_DT25", "DOB_DT", "GNDR_CD", "BENE_RACE_CD", "BENE_CNTY_CD", "BENE_STATE_CD", "CWF_BENE_MDCR_STUS_CD", "CLM_TRTMT_AUTHRZTN_NUM", "CLM_PRCR_RTRN_CD", "CLM_IP_LOW_VOL_PMT_AMT", "CLM_CARE_IMPRVMT_MODEL_CD1", "CLM_CARE_IMPRVMT_MODEL_CD2", "CLM_CARE_IMPRVMT_MODEL_CD3", "CLM_CARE_IMPRVMT_MODEL_CD4", "CLM_BNDLD_MODEL_1_DSCNT_PCT", "CLM_BASE_OPRTG_DRG_AMT", "CLM_VBP_PRTCPNT_IND_CD", "CLM_VBP_ADJSTMT_PCT", "CLM_HRR_PRTCPNT_IND_CD", "CLM_HRR_ADJSTMT_PCT", "CLM_MODEL_4_READMSN_IND_CD", "CLM_UNCOMPD_CARE_PMT_AMT", "CLM_BNDLD_ADJSTMT_PMT_AMT", "CLM_VBP_ADJSTMT_PMT_AMT", "CLM_HRR_ADJSTMT_PMT_AMT", "EHR_PYMT_ADJSTMT_AMT", "PPS_STD_VAL_PYMT_AMT", "FINL_STD_AMT", "HAC_PGM_RDCTN_IND_SW", "EHR_PGM_RDCTN_IND_SW", "CLM_SITE_NTRL_PYMT_CST_AMT", "CLM_SITE_NTRL_PYMT_IPPS_AMT", "CLM_FULL_STD_PYMT_AMT", "CLM_SS_OUTLIER_STD_PYMT_AMT", "CLM_NEXT_GNRTN_ACO_IND_CD1", "CLM_NEXT_GNRTN_ACO_IND_CD2", "CLM_NEXT_GNRTN_ACO_IND_CD3", "CLM_NEXT_GNRTN_ACO_IND_CD4", "CLM_NEXT_GNRTN_ACO_IND_CD5", "ACO_ID_NUM")

colnames_claim_outpatient_2011_2015 <-
  c("DESY_SORT_KEY", "CLAIM_NO", "PRVDR_NUM", "CLM_THRU_DT", "NCH_NEAR_LINE_REC_IDENT_CD", "NCH_CLM_TYPE_CD", "CLAIM_QUERY_CODE", "CLM_FAC_TYPE_CD", "CLM_SRVC_CLSFCTN_TYPE_CD", "CLM_FREQ_CD", "FI_NUM", "CLM_MDCR_NON_PMT_RSN_CD", "CLM_PMT_AMT", "NCH_PRMRY_PYR_CLM_PD_AMT", "NCH_PRMRY_PYR_CD", "PRVDR_STATE_CD", "ORG_NPI_NUM", "AT_PHYSN_UPIN", "AT_PHYSN_NPI", "OP_PHYSN_UPIN", "OP_PHYSN_NPI", "OT_PHYSN_UPIN", "OT_PHYSN_NPI", "CLM_MCO_PD_SW", "PTNT_DSCHRG_STUS_CD", "CLM_TOT_CHRG_AMT", "NCH_BENE_BLOOD_DDCTBL_LBLTY_AM", "NCH_PROFNL_CMPNT_CHRG_AMT", "PRNCPAL_DGNS_CD", "PRNCPAL_DGNS_VRSN_CD", "ICD_DGNS_CD1", "ICD_DGNS_VRSN_CD1", "ICD_DGNS_CD2", "ICD_DGNS_VRSN_CD2", "ICD_DGNS_CD3", "ICD_DGNS_VRSN_CD3", "ICD_DGNS_CD4", "ICD_DGNS_VRSN_CD4", "ICD_DGNS_CD5", "ICD_DGNS_VRSN_CD5", "ICD_DGNS_CD6", "ICD_DGNS_VRSN_CD6", "ICD_DGNS_CD7", "ICD_DGNS_VRSN_CD7", "ICD_DGNS_CD8", "ICD_DGNS_VRSN_CD8", "ICD_DGNS_CD9", "ICD_DGNS_VRSN_CD9", "ICD_DGNS_CD10", "ICD_DGNS_VRSN_CD10", "ICD_DGNS_CD11", "ICD_DGNS_VRSN_CD11", "ICD_DGNS_CD12", "ICD_DGNS_VRSN_CD12", "ICD_DGNS_CD13", "ICD_DGNS_VRSN_CD13", "ICD_DGNS_CD14", "ICD_DGNS_VRSN_CD14", "ICD_DGNS_CD15", "ICD_DGNS_VRSN_CD15", "ICD_DGNS_CD16", "ICD_DGNS_VRSN_CD16", "ICD_DGNS_CD17", "ICD_DGNS_VRSN_CD17", "ICD_DGNS_CD18", "ICD_DGNS_VRSN_CD18", "ICD_DGNS_CD19", "ICD_DGNS_VRSN_CD19", "ICD_DGNS_CD20", "ICD_DGNS_VRSN_CD20", "ICD_DGNS_CD21", "ICD_DGNS_VRSN_CD21", "ICD_DGNS_CD22", "ICD_DGNS_VRSN_CD22", "ICD_DGNS_CD23", "ICD_DGNS_VRSN_CD23", "ICD_DGNS_CD24", "ICD_DGNS_VRSN_CD24", "ICD_DGNS_CD25", "ICD_DGNS_VRSN_CD25", "FST_DGNS_E_CD", "FST_DGNS_E_VRSN_CD", "ICD_DGNS_E_CD1", "ICD_DGNS_E_VRSN_CD1", "ICD_DGNS_E_CD2", "ICD_DGNS_E_VRSN_CD2", "ICD_DGNS_E_CD3", "ICD_DGNS_E_VRSN_CD3", "ICD_DGNS_E_CD4", "ICD_DGNS_E_VRSN_CD4", "ICD_DGNS_E_CD5", "ICD_DGNS_E_VRSN_CD5", "ICD_DGNS_E_CD6", "ICD_DGNS_E_VRSN_CD6", "ICD_DGNS_E_CD7", "ICD_DGNS_E_VRSN_CD7", "ICD_DGNS_E_CD8", "ICD_DGNS_E_VRSN_CD8", "ICD_DGNS_E_CD9", "ICD_DGNS_E_VRSN_CD9", "ICD_DGNS_E_CD10", "ICD_DGNS_E_VRSN_CD10", "ICD_DGNS_E_CD11", "ICD_DGNS_E_VRSN_CD11", "ICD_DGNS_E_CD12", "ICD_DGNS_E_VRSN_CD12", "ICD_PRCDR_CD1", "ICD_PRCDR_VRSN_CD1", "PRCDR_DT1", "ICD_PRCDR_CD2", "ICD_PRCDR_VRSN_CD2", "PRCDR_DT2", "ICD_PRCDR_CD3", "ICD_PRCDR_VRSN_CD3", "PRCDR_DT3", "ICD_PRCDR_CD4", "ICD_PRCDR_VRSN_CD4", "PRCDR_DT4", "ICD_PRCDR_CD5", "ICD_PRCDR_VRSN_CD5", "PRCDR_DT5", "ICD_PRCDR_CD6", "ICD_PRCDR_VRSN_CD6", "PRCDR_DT6", "ICD_PRCDR_CD7", "ICD_PRCDR_VRSN_CD7", "PRCDR_DT7", "ICD_PRCDR_CD8", "ICD_PRCDR_VRSN_CD8", "PRCDR_DT8", "ICD_PRCDR_CD9", "ICD_PRCDR_VRSN_CD9", "PRCDR_DT9", "ICD_PRCDR_CD10", "ICD_PRCDR_VRSN_CD10", "PRCDR_DT10", "ICD_PRCDR_CD11", "ICD_PRCDR_VRSN_CD11", "PRCDR_DT11", "ICD_PRCDR_CD12", "ICD_PRCDR_VRSN_CD12", "PRCDR_DT12", "ICD_PRCDR_CD13", "ICD_PRCDR_VRSN_CD13", "PRCDR_DT13", "ICD_PRCDR_CD14", "ICD_PRCDR_VRSN_CD14", "PRCDR_DT14", "ICD_PRCDR_CD15", "ICD_PRCDR_VRSN_CD15", "PRCDR_DT15", "ICD_PRCDR_CD16", "ICD_PRCDR_VRSN_CD16", "PRCDR_DT16", "ICD_PRCDR_CD17", "ICD_PRCDR_VRSN_CD17", "PRCDR_DT17", "ICD_PRCDR_CD18", "ICD_PRCDR_VRSN_CD18", "PRCDR_DT18", "ICD_PRCDR_CD19", "ICD_PRCDR_VRSN_CD19", "PRCDR_DT19", "ICD_PRCDR_CD20", "ICD_PRCDR_VRSN_CD20", "PRCDR_DT20", "ICD_PRCDR_CD21", "ICD_PRCDR_VRSN_CD21", "PRCDR_DT21", "ICD_PRCDR_CD22", "ICD_PRCDR_VRSN_CD22", "PRCDR_DT22", "ICD_PRCDR_CD23", "ICD_PRCDR_VRSN_CD23", "PRCDR_DT23", "ICD_PRCDR_CD24", "ICD_PRCDR_VRSN_CD24", "PRCDR_DT24", "ICD_PRCDR_CD25", "ICD_PRCDR_VRSN_CD25", "PRCDR_DT25", "RSN_VISIT_CD1", "RSN_VISIT_VRSN_CD1", "RSN_VISIT_CD2", "RSN_VISIT_VRSN_CD2", "RSN_VISIT_CD3", "RSN_VISIT_VRSN_CD3", "NCH_BENE_PTB_DDCTBL_AMT", "NCH_BENE_PTB_COINSRNC_AMT", "CLM_OP_PRVDR_PMT_AMT", "CLM_OP_BENE_PMT_AMT", "DOB_DT", "GNDR_CD", "BENE_RACE_CD", "BENE_CNTY_CD", "BENE_STATE_CD", "CWF_BENE_MDCR_STUS_CD", "FI_CLM_ACTN_CD")

colnames_claim_outpatient_2016_2020 <-
  c("DESY_SORT_KEY", "CLAIM_NO", "PRVDR_NUM", "CLM_THRU_DT", "NCH_NEAR_LINE_REC_IDENT_CD", "NCH_CLM_TYPE_CD", "CLAIM_QUERY_CODE", "CLM_FAC_TYPE_CD", "CLM_SRVC_CLSFCTN_TYPE_CD", "CLM_FREQ_CD", "FI_NUM", "CLM_MDCR_NON_PMT_RSN_CD", "CLM_PMT_AMT", "NCH_PRMRY_PYR_CLM_PD_AMT", "NCH_PRMRY_PYR_CD", "PRVDR_STATE_CD", "ORG_NPI_NUM", "SRVC_LOC_NPI_NUM", "AT_PHYSN_UPIN", "AT_PHYSN_NPI", "AT_PHYSN_SPCLTY_CD", "OP_PHYSN_UPIN", "OP_PHYSN_NPI", "OP_PHYSN_SPCLTY_CD", "OT_PHYSN_UPIN", "OT_PHYSN_NPI", "OT_PHYSN_SPCLTY_CD", "RNDRNG_PHYSN_NPI", "RNDRNG_PHYSN_SPCLTY_CD", "RFR_PHYSN_NPI", "RFR_PHYSN_SPCLTY_CD", "CLM_MCO_PD_SW", "PTNT_DSCHRG_STUS_CD", "CLM_TOT_CHRG_AMT", "NCH_BENE_BLOOD_DDCTBL_LBLTY_AM", "NCH_PROFNL_CMPNT_CHRG_AMT", "PRNCPAL_DGNS_CD", "ICD_DGNS_CD1", "ICD_DGNS_CD2", "ICD_DGNS_CD3", "ICD_DGNS_CD4", "ICD_DGNS_CD5", "ICD_DGNS_CD6", "ICD_DGNS_CD7", "ICD_DGNS_CD8", "ICD_DGNS_CD9", "ICD_DGNS_CD10", "ICD_DGNS_CD11", "ICD_DGNS_CD12", "ICD_DGNS_CD13", "ICD_DGNS_CD14", "ICD_DGNS_CD15", "ICD_DGNS_CD16", "ICD_DGNS_CD17", "ICD_DGNS_CD18", "ICD_DGNS_CD19", "ICD_DGNS_CD20", "ICD_DGNS_CD21", "ICD_DGNS_CD22", "ICD_DGNS_CD23", "ICD_DGNS_CD24", "ICD_DGNS_CD25", "FST_DGNS_E_CD", "ICD_DGNS_E_CD1", "ICD_DGNS_E_CD2", "ICD_DGNS_E_CD3", "ICD_DGNS_E_CD4", "ICD_DGNS_E_CD5", "ICD_DGNS_E_CD6", "ICD_DGNS_E_CD7", "ICD_DGNS_E_CD8", "ICD_DGNS_E_CD9", "ICD_DGNS_E_CD10", "ICD_DGNS_E_CD11", "ICD_DGNS_E_CD12", "ICD_PRCDR_CD1", "PRCDR_DT1", "ICD_PRCDR_CD2", "PRCDR_DT2", "ICD_PRCDR_CD3", "PRCDR_DT3", "ICD_PRCDR_CD4", "PRCDR_DT4", "ICD_PRCDR_CD5", "PRCDR_DT5", "ICD_PRCDR_CD6", "PRCDR_DT6", "ICD_PRCDR_CD7", "PRCDR_DT7", "ICD_PRCDR_CD8", "PRCDR_DT8", "ICD_PRCDR_CD9", "PRCDR_DT9", "ICD_PRCDR_CD10", "PRCDR_DT10", "ICD_PRCDR_CD11", "PRCDR_DT11", "ICD_PRCDR_CD12", "PRCDR_DT12", "ICD_PRCDR_CD13", "PRCDR_DT13", "ICD_PRCDR_CD14", "PRCDR_DT14", "ICD_PRCDR_CD15", "PRCDR_DT15", "ICD_PRCDR_CD16", "PRCDR_DT16", "ICD_PRCDR_CD17", "PRCDR_DT17", "ICD_PRCDR_CD18", "PRCDR_DT18", "ICD_PRCDR_CD19", "PRCDR_DT19", "ICD_PRCDR_CD20", "PRCDR_DT20", "ICD_PRCDR_CD21", "PRCDR_DT21", "ICD_PRCDR_CD22", "PRCDR_DT22", "ICD_PRCDR_CD23", "PRCDR_DT23", "ICD_PRCDR_CD24", "PRCDR_DT24", "ICD_PRCDR_CD25", "PRCDR_DT25", "RSN_VISIT_CD1", "RSN_VISIT_CD2", "RSN_VISIT_CD3", "NCH_BENE_PTB_DDCTBL_AMT", "NCH_BENE_PTB_COINSRNC_AMT", "CLM_OP_PRVDR_PMT_AMT", "CLM_OP_BENE_PMT_AMT", "DOB_DT", "GNDR_CD", "BENE_RACE_CD", "BENE_CNTY_CD", "BENE_STATE_CD", "CWF_BENE_MDCR_STUS_CD", "FI_CLM_ACTN_CD", "NCH_BLOOD_PNTS_FRNSHD_QTY", "CLM_TRTMT_AUTHRZTN_NUM", "CLM_PRCR_RTRN_CD", "CLM_OP_TRANS_TYPE_CD", "CLM_OP_ESRD_MTHD_CD", "CLM_NEXT_GNRTN_ACO_IND_CD1", "CLM_NEXT_GNRTN_ACO_IND_CD2", "CLM_NEXT_GNRTN_ACO_IND_CD3", "CLM_NEXT_GNRTN_ACO_IND_CD4", "CLM_NEXT_GNRTN_ACO_IND_CD5", "ACO_ID_NUM")
```

```{r}
colnames(claim_carrier_2013) <- colnames_claim_carrier_2011_2015
colnames(claim_carrier_2014) <- colnames_claim_carrier_2011_2015
colnames(claim_carrier_2015) <- colnames_claim_carrier_2011_2015
colnames(claim_carrier_2016) <- colnames_claim_carrier_2016_2020
colnames(claim_carrier_2017) <- colnames_claim_carrier_2016_2020
colnames(claim_carrier_2018) <- colnames_claim_carrier_2016_2020
colnames(claim_carrier_2019) <- colnames_claim_carrier_2016_2020
colnames(claim_carrier_2020) <- colnames_claim_carrier_2016_2020


colnames(claim_inpatient_2013) <- colnames_claim_inpatient_2011_2015
colnames(claim_inpatient_2014) <- colnames_claim_inpatient_2011_2015
colnames(claim_inpatient_2015) <- colnames_claim_inpatient_2011_2015
colnames(claim_inpatient_2016) <- colnames_claim_inpatient_2016_2020
colnames(claim_inpatient_2017) <- colnames_claim_inpatient_2016_2020
colnames(claim_inpatient_2018) <- colnames_claim_inpatient_2016_2020
colnames(claim_inpatient_2019) <- colnames_claim_inpatient_2016_2020
colnames(claim_inpatient_2020) <- colnames_claim_inpatient_2016_2020


colnames(claim_outpatient_2013) <- colnames_claim_outpatient_2011_2015
colnames(claim_outpatient_2014) <- colnames_claim_outpatient_2011_2015
colnames(claim_outpatient_2015) <- colnames_claim_outpatient_2011_2015
colnames(claim_outpatient_2016) <- colnames_claim_outpatient_2016_2020
colnames(claim_outpatient_2017) <- colnames_claim_outpatient_2016_2020
colnames(claim_outpatient_2018) <- colnames_claim_outpatient_2016_2020
colnames(claim_outpatient_2019) <- colnames_claim_outpatient_2016_2020
colnames(claim_outpatient_2020) <- colnames_claim_outpatient_2016_2020
```

```{r}
claim_inpatient_2016[,":="(ADMTG_DGNS_VRSN_CD =0, PRNCPAL_DGNS_VRSN_CD=0, ICD_DGNS_VRSN_CD1=0, ICD_DGNS_VRSN_CD2=0, ICD_DGNS_VRSN_CD3=0, ICD_DGNS_VRSN_CD4=0, ICD_DGNS_VRSN_CD5=0, ICD_DGNS_VRSN_CD6=0, ICD_DGNS_VRSN_CD7=0, ICD_DGNS_VRSN_CD8=0, ICD_DGNS_VRSN_CD9=0, ICD_DGNS_VRSN_CD10=0, ICD_DGNS_VRSN_CD11=0, ICD_DGNS_VRSN_CD12=0, ICD_DGNS_VRSN_CD13=0, ICD_DGNS_VRSN_CD14=0, ICD_DGNS_VRSN_CD15=0, ICD_DGNS_VRSN_CD16=0, ICD_DGNS_VRSN_CD17=0, ICD_DGNS_VRSN_CD18=0, ICD_DGNS_VRSN_CD19=0, ICD_DGNS_VRSN_CD20=0, ICD_DGNS_VRSN_CD21=0, ICD_DGNS_VRSN_CD22=0, ICD_DGNS_VRSN_CD23=0, ICD_DGNS_VRSN_CD24=0, ICD_DGNS_VRSN_CD25=0)]

claim_inpatient_2017[,":="(ADMTG_DGNS_VRSN_CD =0, PRNCPAL_DGNS_VRSN_CD=0, ICD_DGNS_VRSN_CD1=0, ICD_DGNS_VRSN_CD2=0, ICD_DGNS_VRSN_CD3=0, ICD_DGNS_VRSN_CD4=0, ICD_DGNS_VRSN_CD5=0, ICD_DGNS_VRSN_CD6=0, ICD_DGNS_VRSN_CD7=0, ICD_DGNS_VRSN_CD8=0, ICD_DGNS_VRSN_CD9=0, ICD_DGNS_VRSN_CD10=0, ICD_DGNS_VRSN_CD11=0, ICD_DGNS_VRSN_CD12=0, ICD_DGNS_VRSN_CD13=0, ICD_DGNS_VRSN_CD14=0, ICD_DGNS_VRSN_CD15=0, ICD_DGNS_VRSN_CD16=0, ICD_DGNS_VRSN_CD17=0, ICD_DGNS_VRSN_CD18=0, ICD_DGNS_VRSN_CD19=0, ICD_DGNS_VRSN_CD20=0, ICD_DGNS_VRSN_CD21=0, ICD_DGNS_VRSN_CD22=0, ICD_DGNS_VRSN_CD23=0, ICD_DGNS_VRSN_CD24=0, ICD_DGNS_VRSN_CD25=0)]

claim_inpatient_2018[,":="(ADMTG_DGNS_VRSN_CD =0, PRNCPAL_DGNS_VRSN_CD=0, ICD_DGNS_VRSN_CD1=0, ICD_DGNS_VRSN_CD2=0, ICD_DGNS_VRSN_CD3=0, ICD_DGNS_VRSN_CD4=0, ICD_DGNS_VRSN_CD5=0, ICD_DGNS_VRSN_CD6=0, ICD_DGNS_VRSN_CD7=0, ICD_DGNS_VRSN_CD8=0, ICD_DGNS_VRSN_CD9=0, ICD_DGNS_VRSN_CD10=0, ICD_DGNS_VRSN_CD11=0, ICD_DGNS_VRSN_CD12=0, ICD_DGNS_VRSN_CD13=0, ICD_DGNS_VRSN_CD14=0, ICD_DGNS_VRSN_CD15=0, ICD_DGNS_VRSN_CD16=0, ICD_DGNS_VRSN_CD17=0, ICD_DGNS_VRSN_CD18=0, ICD_DGNS_VRSN_CD19=0, ICD_DGNS_VRSN_CD20=0, ICD_DGNS_VRSN_CD21=0, ICD_DGNS_VRSN_CD22=0, ICD_DGNS_VRSN_CD23=0, ICD_DGNS_VRSN_CD24=0, ICD_DGNS_VRSN_CD25=0)]

claim_inpatient_2019[,":="(ADMTG_DGNS_VRSN_CD =0, PRNCPAL_DGNS_VRSN_CD=0, ICD_DGNS_VRSN_CD1=0, ICD_DGNS_VRSN_CD2=0, ICD_DGNS_VRSN_CD3=0, ICD_DGNS_VRSN_CD4=0, ICD_DGNS_VRSN_CD5=0, ICD_DGNS_VRSN_CD6=0, ICD_DGNS_VRSN_CD7=0, ICD_DGNS_VRSN_CD8=0, ICD_DGNS_VRSN_CD9=0, ICD_DGNS_VRSN_CD10=0, ICD_DGNS_VRSN_CD11=0, ICD_DGNS_VRSN_CD12=0, ICD_DGNS_VRSN_CD13=0, ICD_DGNS_VRSN_CD14=0, ICD_DGNS_VRSN_CD15=0, ICD_DGNS_VRSN_CD16=0, ICD_DGNS_VRSN_CD17=0, ICD_DGNS_VRSN_CD18=0, ICD_DGNS_VRSN_CD19=0, ICD_DGNS_VRSN_CD20=0, ICD_DGNS_VRSN_CD21=0, ICD_DGNS_VRSN_CD22=0, ICD_DGNS_VRSN_CD23=0, ICD_DGNS_VRSN_CD24=0, ICD_DGNS_VRSN_CD25=0)]

claim_inpatient_2020[,":="(ADMTG_DGNS_VRSN_CD =0, PRNCPAL_DGNS_VRSN_CD=0, ICD_DGNS_VRSN_CD1=0, ICD_DGNS_VRSN_CD2=0, ICD_DGNS_VRSN_CD3=0, ICD_DGNS_VRSN_CD4=0, ICD_DGNS_VRSN_CD5=0, ICD_DGNS_VRSN_CD6=0, ICD_DGNS_VRSN_CD7=0, ICD_DGNS_VRSN_CD8=0, ICD_DGNS_VRSN_CD9=0, ICD_DGNS_VRSN_CD10=0, ICD_DGNS_VRSN_CD11=0, ICD_DGNS_VRSN_CD12=0, ICD_DGNS_VRSN_CD13=0, ICD_DGNS_VRSN_CD14=0, ICD_DGNS_VRSN_CD15=0, ICD_DGNS_VRSN_CD16=0, ICD_DGNS_VRSN_CD17=0, ICD_DGNS_VRSN_CD18=0, ICD_DGNS_VRSN_CD19=0, ICD_DGNS_VRSN_CD20=0, ICD_DGNS_VRSN_CD21=0, ICD_DGNS_VRSN_CD22=0, ICD_DGNS_VRSN_CD23=0, ICD_DGNS_VRSN_CD24=0, ICD_DGNS_VRSN_CD25=0)]
```

```{r}


claim_outpatient_2016[,":="(PRNCPAL_DGNS_VRSN_CD=0, ICD_DGNS_VRSN_CD1=0, ICD_DGNS_VRSN_CD2=0, ICD_DGNS_VRSN_CD3=0, ICD_DGNS_VRSN_CD4=0, ICD_DGNS_VRSN_CD5=0, ICD_DGNS_VRSN_CD6=0, ICD_DGNS_VRSN_CD7=0, ICD_DGNS_VRSN_CD8=0, ICD_DGNS_VRSN_CD9=0, ICD_DGNS_VRSN_CD10=0, ICD_DGNS_VRSN_CD11=0, ICD_DGNS_VRSN_CD12=0, ICD_DGNS_VRSN_CD13=0, ICD_DGNS_VRSN_CD14=0, ICD_DGNS_VRSN_CD15=0, ICD_DGNS_VRSN_CD16=0, ICD_DGNS_VRSN_CD17=0, ICD_DGNS_VRSN_CD18=0, ICD_DGNS_VRSN_CD19=0, ICD_DGNS_VRSN_CD20=0, ICD_DGNS_VRSN_CD21=0, ICD_DGNS_VRSN_CD22=0, ICD_DGNS_VRSN_CD23=0, ICD_DGNS_VRSN_CD24=0, ICD_DGNS_VRSN_CD25=0)]

claim_outpatient_2017[,":="( PRNCPAL_DGNS_VRSN_CD=0, ICD_DGNS_VRSN_CD1=0, ICD_DGNS_VRSN_CD2=0, ICD_DGNS_VRSN_CD3=0, ICD_DGNS_VRSN_CD4=0, ICD_DGNS_VRSN_CD5=0, ICD_DGNS_VRSN_CD6=0, ICD_DGNS_VRSN_CD7=0, ICD_DGNS_VRSN_CD8=0, ICD_DGNS_VRSN_CD9=0, ICD_DGNS_VRSN_CD10=0, ICD_DGNS_VRSN_CD11=0, ICD_DGNS_VRSN_CD12=0, ICD_DGNS_VRSN_CD13=0, ICD_DGNS_VRSN_CD14=0, ICD_DGNS_VRSN_CD15=0, ICD_DGNS_VRSN_CD16=0, ICD_DGNS_VRSN_CD17=0, ICD_DGNS_VRSN_CD18=0, ICD_DGNS_VRSN_CD19=0, ICD_DGNS_VRSN_CD20=0, ICD_DGNS_VRSN_CD21=0, ICD_DGNS_VRSN_CD22=0, ICD_DGNS_VRSN_CD23=0, ICD_DGNS_VRSN_CD24=0, ICD_DGNS_VRSN_CD25=0)]

claim_outpatient_2018[,":="( PRNCPAL_DGNS_VRSN_CD=0, ICD_DGNS_VRSN_CD1=0, ICD_DGNS_VRSN_CD2=0, ICD_DGNS_VRSN_CD3=0, ICD_DGNS_VRSN_CD4=0, ICD_DGNS_VRSN_CD5=0, ICD_DGNS_VRSN_CD6=0, ICD_DGNS_VRSN_CD7=0, ICD_DGNS_VRSN_CD8=0, ICD_DGNS_VRSN_CD9=0, ICD_DGNS_VRSN_CD10=0, ICD_DGNS_VRSN_CD11=0, ICD_DGNS_VRSN_CD12=0, ICD_DGNS_VRSN_CD13=0, ICD_DGNS_VRSN_CD14=0, ICD_DGNS_VRSN_CD15=0, ICD_DGNS_VRSN_CD16=0, ICD_DGNS_VRSN_CD17=0, ICD_DGNS_VRSN_CD18=0, ICD_DGNS_VRSN_CD19=0, ICD_DGNS_VRSN_CD20=0, ICD_DGNS_VRSN_CD21=0, ICD_DGNS_VRSN_CD22=0, ICD_DGNS_VRSN_CD23=0, ICD_DGNS_VRSN_CD24=0, ICD_DGNS_VRSN_CD25=0)]

claim_outpatient_2019[,":="( PRNCPAL_DGNS_VRSN_CD=0, ICD_DGNS_VRSN_CD1=0, ICD_DGNS_VRSN_CD2=0, ICD_DGNS_VRSN_CD3=0, ICD_DGNS_VRSN_CD4=0, ICD_DGNS_VRSN_CD5=0, ICD_DGNS_VRSN_CD6=0, ICD_DGNS_VRSN_CD7=0, ICD_DGNS_VRSN_CD8=0, ICD_DGNS_VRSN_CD9=0, ICD_DGNS_VRSN_CD10=0, ICD_DGNS_VRSN_CD11=0, ICD_DGNS_VRSN_CD12=0, ICD_DGNS_VRSN_CD13=0, ICD_DGNS_VRSN_CD14=0, ICD_DGNS_VRSN_CD15=0, ICD_DGNS_VRSN_CD16=0, ICD_DGNS_VRSN_CD17=0, ICD_DGNS_VRSN_CD18=0, ICD_DGNS_VRSN_CD19=0, ICD_DGNS_VRSN_CD20=0, ICD_DGNS_VRSN_CD21=0, ICD_DGNS_VRSN_CD22=0, ICD_DGNS_VRSN_CD23=0, ICD_DGNS_VRSN_CD24=0, ICD_DGNS_VRSN_CD25=0)]

claim_outpatient_2020[,":="( PRNCPAL_DGNS_VRSN_CD=0, ICD_DGNS_VRSN_CD1=0, ICD_DGNS_VRSN_CD2=0, ICD_DGNS_VRSN_CD3=0, ICD_DGNS_VRSN_CD4=0, ICD_DGNS_VRSN_CD5=0, ICD_DGNS_VRSN_CD6=0, ICD_DGNS_VRSN_CD7=0, ICD_DGNS_VRSN_CD8=0, ICD_DGNS_VRSN_CD9=0, ICD_DGNS_VRSN_CD10=0, ICD_DGNS_VRSN_CD11=0, ICD_DGNS_VRSN_CD12=0, ICD_DGNS_VRSN_CD13=0, ICD_DGNS_VRSN_CD14=0, ICD_DGNS_VRSN_CD15=0, ICD_DGNS_VRSN_CD16=0, ICD_DGNS_VRSN_CD17=0, ICD_DGNS_VRSN_CD18=0, ICD_DGNS_VRSN_CD19=0, ICD_DGNS_VRSN_CD20=0, ICD_DGNS_VRSN_CD21=0, ICD_DGNS_VRSN_CD22=0, ICD_DGNS_VRSN_CD23=0, ICD_DGNS_VRSN_CD24=0, ICD_DGNS_VRSN_CD25=0)]

```

```{r}
head(claim_outpatient_2016)
```

```{r pycharm={'name': '#%%\n'}, tags=c()}
choose_columns <- function(data_list, columns) {
  require(data.table)
  data_list <- lapply(data_list, function(data) {
    data[, ..columns]
  })
  result <- rbindlist(data_list)
  return(result)
}

claim_carrier_all_years <- choose_columns(
  list(
    claim_carrier_2013,
    claim_carrier_2014,
    claim_carrier_2015,
    claim_carrier_2016,
    claim_carrier_2017,
    claim_carrier_2018,
    claim_carrier_2019,
    claim_carrier_2020
  ),
  columns = c("DESY_SORT_KEY", "CLAIM_NO", "CLM_THRU_DT", "PRNCPAL_DGNS_CD", "PRNCPAL_DGNS_VRSN_CD", "ICD_DGNS_CD1", "ICD_DGNS_VRSN_CD1", "ICD_DGNS_CD2", "ICD_DGNS_VRSN_CD2", "ICD_DGNS_CD3", "ICD_DGNS_VRSN_CD3", "ICD_DGNS_CD4", "ICD_DGNS_VRSN_CD4", "ICD_DGNS_CD5", "ICD_DGNS_VRSN_CD5", "ICD_DGNS_CD6", "ICD_DGNS_VRSN_CD6", "ICD_DGNS_CD7", "ICD_DGNS_VRSN_CD7", "ICD_DGNS_CD8", "ICD_DGNS_VRSN_CD8", "ICD_DGNS_CD9", "ICD_DGNS_VRSN_CD9", "ICD_DGNS_CD10", "ICD_DGNS_VRSN_CD10", "ICD_DGNS_CD11", "ICD_DGNS_VRSN_CD11", "ICD_DGNS_CD12", "ICD_DGNS_VRSN_CD12")
)

claim_carrier_all_years[, date := as.IDate(as.character(CLM_THRU_DT), "%Y%m%d")][order(date)]
claim_carrier_all_years[, month_year := format(date, "%Y-%m")]
claim_carrier_all_years[, DESY_SORT_KEY := as.integer(DESY_SORT_KEY)]


claim_inpatient_all_years <- choose_columns(
  list(
    claim_inpatient_2013,
    claim_inpatient_2014,
    claim_inpatient_2015,
    claim_inpatient_2016,
    claim_inpatient_2017,
    claim_inpatient_2018,
    claim_inpatient_2019,
    claim_inpatient_2020
  ),
  columns = c("DESY_SORT_KEY", "CLAIM_NO", "CLM_THRU_DT", "ADMTG_DGNS_CD", "ADMTG_DGNS_VRSN_CD", "PRNCPAL_DGNS_CD", "PRNCPAL_DGNS_VRSN_CD", "ICD_DGNS_CD1", "ICD_DGNS_VRSN_CD1", "CLM_POA_IND_SW1", "ICD_DGNS_CD2", "ICD_DGNS_VRSN_CD2", "CLM_POA_IND_SW2", "ICD_DGNS_CD3", "ICD_DGNS_VRSN_CD3", "CLM_POA_IND_SW3", "ICD_DGNS_CD4", "ICD_DGNS_VRSN_CD4", "CLM_POA_IND_SW4", "ICD_DGNS_CD5", "ICD_DGNS_VRSN_CD5", "CLM_POA_IND_SW5", "ICD_DGNS_CD6", "ICD_DGNS_VRSN_CD6", "CLM_POA_IND_SW6", "ICD_DGNS_CD7", "ICD_DGNS_VRSN_CD7", "CLM_POA_IND_SW7", "ICD_DGNS_CD8", "ICD_DGNS_VRSN_CD8", "CLM_POA_IND_SW8", "ICD_DGNS_CD9", "ICD_DGNS_VRSN_CD9", "CLM_POA_IND_SW9", "ICD_DGNS_CD10", "ICD_DGNS_VRSN_CD10", "CLM_POA_IND_SW10", "ICD_DGNS_CD11", "ICD_DGNS_VRSN_CD11", "CLM_POA_IND_SW11", "ICD_DGNS_CD12", "ICD_DGNS_VRSN_CD12", "CLM_POA_IND_SW12", "ICD_DGNS_CD13", "ICD_DGNS_VRSN_CD13", "CLM_POA_IND_SW13", "ICD_DGNS_CD14", "ICD_DGNS_VRSN_CD14", "CLM_POA_IND_SW14", "ICD_DGNS_CD15", "ICD_DGNS_VRSN_CD15", "CLM_POA_IND_SW15", "ICD_DGNS_CD16", "ICD_DGNS_VRSN_CD16", "CLM_POA_IND_SW16", "ICD_DGNS_CD17", "ICD_DGNS_VRSN_CD17", "CLM_POA_IND_SW17", "ICD_DGNS_CD18", "ICD_DGNS_VRSN_CD18", "CLM_POA_IND_SW18", "ICD_DGNS_CD19", "ICD_DGNS_VRSN_CD19", "CLM_POA_IND_SW19", "ICD_DGNS_CD20", "ICD_DGNS_VRSN_CD20", "CLM_POA_IND_SW20", "ICD_DGNS_CD21", "ICD_DGNS_VRSN_CD21", "CLM_POA_IND_SW21", "ICD_DGNS_CD22", "ICD_DGNS_VRSN_CD22", "CLM_POA_IND_SW22", "ICD_DGNS_CD23", "ICD_DGNS_VRSN_CD23", "CLM_POA_IND_SW23", "ICD_DGNS_CD24", "ICD_DGNS_VRSN_CD24", "CLM_POA_IND_SW24", "ICD_DGNS_CD25", "ICD_DGNS_VRSN_CD25", "CLM_POA_IND_SW25")
)

claim_inpatient_all_years[, date := as.IDate(as.character(CLM_THRU_DT), "%Y%m%d")][order(date)]
claim_inpatient_all_years[, month_year := format(date, "%Y-%m")]
claim_inpatient_all_years[, DESY_SORT_KEY := as.integer(DESY_SORT_KEY)]


claim_outpatient_all_years <- choose_columns(
  list(
    claim_outpatient_2013,
    claim_outpatient_2014,
    claim_outpatient_2015,
    claim_outpatient_2016,
    claim_outpatient_2017,
    claim_outpatient_2018,
    claim_outpatient_2019,
    claim_outpatient_2020
  ),
  columns = c("DESY_SORT_KEY", "CLAIM_NO", "CLM_THRU_DT", "PRNCPAL_DGNS_CD", "PRNCPAL_DGNS_VRSN_CD", "ICD_DGNS_CD1", "ICD_DGNS_VRSN_CD1", "ICD_DGNS_CD2", "ICD_DGNS_VRSN_CD2", "ICD_DGNS_CD3", "ICD_DGNS_VRSN_CD3", "ICD_DGNS_CD4", "ICD_DGNS_VRSN_CD4", "ICD_DGNS_CD5", "ICD_DGNS_VRSN_CD5", "ICD_DGNS_CD6", "ICD_DGNS_VRSN_CD6", "ICD_DGNS_CD7", "ICD_DGNS_VRSN_CD7", "ICD_DGNS_CD8", "ICD_DGNS_VRSN_CD8", "ICD_DGNS_CD9", "ICD_DGNS_VRSN_CD9", "ICD_DGNS_CD10", "ICD_DGNS_VRSN_CD10", "ICD_DGNS_CD11", "ICD_DGNS_VRSN_CD11", "ICD_DGNS_CD12", "ICD_DGNS_VRSN_CD12", "ICD_DGNS_CD13", "ICD_DGNS_VRSN_CD13", "ICD_DGNS_CD14", "ICD_DGNS_VRSN_CD14", "ICD_DGNS_CD15", "ICD_DGNS_VRSN_CD15", "ICD_DGNS_CD16", "ICD_DGNS_VRSN_CD16", "ICD_DGNS_CD17", "ICD_DGNS_VRSN_CD17", "ICD_DGNS_CD18", "ICD_DGNS_VRSN_CD18", "ICD_DGNS_CD19", "ICD_DGNS_VRSN_CD19", "ICD_DGNS_CD20", "ICD_DGNS_VRSN_CD20", "ICD_DGNS_CD21", "ICD_DGNS_VRSN_CD21", "ICD_DGNS_CD22", "ICD_DGNS_VRSN_CD22", "ICD_DGNS_CD23", "ICD_DGNS_VRSN_CD23", "ICD_DGNS_CD24", "ICD_DGNS_VRSN_CD24", "ICD_DGNS_CD25", "ICD_DGNS_VRSN_CD25")
)

claim_outpatient_all_years[, date := as.IDate(as.character(CLM_THRU_DT), "%Y%m%d")][order(date)]
claim_outpatient_all_years[, month_year := format(date, "%Y-%m")]
claim_outpatient_all_years[, DESY_SORT_KEY := as.integer(DESY_SORT_KEY)]
```

```{r}
claim_carrier_all_years[, year := format(date, "%Y")]

claim_inpatient_all_years[, year := format(date, "%Y")]

claim_outpatient_all_years[, year := format(date, "%Y")]
```

```{r pycharm={'name': '#%%\n'}}
write_fst(claim_carrier_all_years, "/work/postresearch/Shared/Projects/Data_fst/claim_carrier_all_years.fst")
write_fst(claim_inpatient_all_years, "/work/postresearch/Shared/Projects/Data_fst/claim_inpatient_all_years.fst")
write_fst(claim_outpatient_all_years, "/work/postresearch/Shared/Projects/Data_fst/claim_outpatient_all_years.fst")
```

<!-- #region tags=[] jp-MarkdownHeadingCollapsed=true jp-MarkdownHeadingCollapsed=true tags=[] -->
## Reading fst claim level files
<!-- #endregion -->

```{r}
claim_carrier_all_years=read_fst("/work/postresearch/Shared/Projects/Data_fst/claim_carrier_all_years.fst",as.data.table = T)
claim_inpatient_all_years=read_fst("/work/postresearch/Shared/Projects/Data_fst/claim_inpatient_all_years.fst",as.data.table = T)
claim_outpatient_all_years=read_fst("/work/postresearch/Shared/Projects/Data_fst/claim_outpatient_all_years.fst",as.data.table = T)
```

```{r tags=c()}
head(claim_carrier_all_years)
head(claim_inpatient_all_years)
head(claim_outpatient_all_years)
```

```{r}
nrow(claim_carrier_all_years)
nrow(claim_inpatient_all_years)
nrow(claim_outpatient_all_years)
```

<!-- #region jp-MarkdownHeadingCollapsed=true tags=[] jp-MarkdownHeadingCollapsed=true -->
## Conditions
<!-- #endregion -->

### Carrier

```{r}
claim_carrier_all_years[PRNCPAL_DGNS_VRSN_CD == 9 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
                                                                         ICD_DGNS_CD1,
                                                                         ICD_DGNS_CD2,
                                                                         ICD_DGNS_CD3,
                                                                         ICD_DGNS_CD4,
                                                                         ICD_DGNS_CD5,
                                                                         ICD_DGNS_CD6,
                                                                         ICD_DGNS_CD7,
                                                                         ICD_DGNS_CD8,
                                                                         ICD_DGNS_CD9,
                                                                         ICD_DGNS_CD10,
                                                                         ICD_DGNS_CD11,
                                                                         ICD_DGNS_CD12), hypertension_icd_9_codes)), is_hypertension:=T]

claim_carrier_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
                                                                         ICD_DGNS_CD1,
                                                                         ICD_DGNS_CD2,
                                                                         ICD_DGNS_CD3,
                                                                         ICD_DGNS_CD4,
                                                                         ICD_DGNS_CD5,
                                                                         ICD_DGNS_CD6,
                                                                         ICD_DGNS_CD7,
                                                                         ICD_DGNS_CD8,
                                                                         ICD_DGNS_CD9,
                                                                         ICD_DGNS_CD10,
                                                                         ICD_DGNS_CD11,
                                                                         ICD_DGNS_CD12), hypertension_icd_10_codes)), is_hypertension:=T]


claim_carrier_all_years[PRNCPAL_DGNS_VRSN_CD == 9 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
                                                                         ICD_DGNS_CD1,
                                                                         ICD_DGNS_CD2,
                                                                         ICD_DGNS_CD3,
                                                                         ICD_DGNS_CD4,
                                                                         ICD_DGNS_CD5,
                                                                         ICD_DGNS_CD6,
                                                                         ICD_DGNS_CD7,
                                                                         ICD_DGNS_CD8,
                                                                         ICD_DGNS_CD9,
                                                                         ICD_DGNS_CD10,
                                                                         ICD_DGNS_CD11,
                                                                         ICD_DGNS_CD12), arthritis_icd_9_codes)), is_arthritis:=T]

claim_carrier_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
                                                                         ICD_DGNS_CD1,
                                                                         ICD_DGNS_CD2,
                                                                         ICD_DGNS_CD3,
                                                                         ICD_DGNS_CD4,
                                                                         ICD_DGNS_CD5,
                                                                         ICD_DGNS_CD6,
                                                                         ICD_DGNS_CD7,
                                                                         ICD_DGNS_CD8,
                                                                         ICD_DGNS_CD9,
                                                                         ICD_DGNS_CD10,
                                                                         ICD_DGNS_CD11,
                                                                         ICD_DGNS_CD12), arthritis_icd_10_codes_1)), is_arthritis:=T]
claim_carrier_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
                                                                         ICD_DGNS_CD1,
                                                                         ICD_DGNS_CD2,
                                                                         ICD_DGNS_CD3,
                                                                         ICD_DGNS_CD4,
                                                                         ICD_DGNS_CD5,
                                                                         ICD_DGNS_CD6,
                                                                         ICD_DGNS_CD7,
                                                                         ICD_DGNS_CD8,
                                                                         ICD_DGNS_CD9,
                                                                         ICD_DGNS_CD10,
                                                                         ICD_DGNS_CD11,
                                                                         ICD_DGNS_CD12), arthritis_icd_10_codes_2)), is_arthritis:=T]
claim_carrier_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
                                                                         ICD_DGNS_CD1,
                                                                         ICD_DGNS_CD2,
                                                                         ICD_DGNS_CD3,
                                                                         ICD_DGNS_CD4,
                                                                         ICD_DGNS_CD5,
                                                                         ICD_DGNS_CD6,
                                                                         ICD_DGNS_CD7,
                                                                         ICD_DGNS_CD8,
                                                                         ICD_DGNS_CD9,
                                                                         ICD_DGNS_CD10,
                                                                         ICD_DGNS_CD11,
                                                                         ICD_DGNS_CD12), arthritis_icd_10_codes_3)), is_arthritis:=T]
claim_carrier_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
                                                                         ICD_DGNS_CD1,
                                                                         ICD_DGNS_CD2,
                                                                         ICD_DGNS_CD3,
                                                                         ICD_DGNS_CD4,
                                                                         ICD_DGNS_CD5,
                                                                         ICD_DGNS_CD6,
                                                                         ICD_DGNS_CD7,
                                                                         ICD_DGNS_CD8,
                                                                         ICD_DGNS_CD9,
                                                                         ICD_DGNS_CD10,
                                                                         ICD_DGNS_CD11,
                                                                         ICD_DGNS_CD12), arthritis_icd_10_codes_4)), is_arthritis:=T]




claim_carrier_all_years[PRNCPAL_DGNS_VRSN_CD == 9 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
                                                                         ICD_DGNS_CD1,
                                                                         ICD_DGNS_CD2,
                                                                         ICD_DGNS_CD3,
                                                                         ICD_DGNS_CD4,
                                                                         ICD_DGNS_CD5,
                                                                         ICD_DGNS_CD6,
                                                                         ICD_DGNS_CD7,
                                                                         ICD_DGNS_CD8,
                                                                         ICD_DGNS_CD9,
                                                                         ICD_DGNS_CD10,
                                                                         ICD_DGNS_CD11,
                                                                         ICD_DGNS_CD12), IHD_icd_9_codes)), is_IHD:=T]

claim_carrier_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
                                                                         ICD_DGNS_CD1,
                                                                         ICD_DGNS_CD2,
                                                                         ICD_DGNS_CD3,
                                                                         ICD_DGNS_CD4,
                                                                         ICD_DGNS_CD5,
                                                                         ICD_DGNS_CD6,
                                                                         ICD_DGNS_CD7,
                                                                         ICD_DGNS_CD8,
                                                                         ICD_DGNS_CD9,
                                                                         ICD_DGNS_CD10,
                                                                         ICD_DGNS_CD11,
                                                                         ICD_DGNS_CD12), IHD_icd_10_codes)), is_IHD:=T]

claim_carrier_all_years[PRNCPAL_DGNS_VRSN_CD == 9 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
                                                                         ICD_DGNS_CD1,
                                                                         ICD_DGNS_CD2,
                                                                         ICD_DGNS_CD3,
                                                                         ICD_DGNS_CD4,
                                                                         ICD_DGNS_CD5,
                                                                         ICD_DGNS_CD6,
                                                                         ICD_DGNS_CD7,
                                                                         ICD_DGNS_CD8,
                                                                         ICD_DGNS_CD9,
                                                                         ICD_DGNS_CD10,
                                                                         ICD_DGNS_CD11,
                                                                         ICD_DGNS_CD12), diabetes_icd_9_codes)), is_diabetes:=T]

claim_carrier_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
                                                                         ICD_DGNS_CD1,
                                                                         ICD_DGNS_CD2,
                                                                         ICD_DGNS_CD3,
                                                                         ICD_DGNS_CD4,
                                                                         ICD_DGNS_CD5,
                                                                         ICD_DGNS_CD6,
                                                                         ICD_DGNS_CD7,
                                                                         ICD_DGNS_CD8,
                                                                         ICD_DGNS_CD9,
                                                                         ICD_DGNS_CD10,
                                                                         ICD_DGNS_CD11,
                                                                         ICD_DGNS_CD12), diabetes_icd_10_codes_1)), is_diabetes:=T]
claim_carrier_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
                                                                         ICD_DGNS_CD1,
                                                                         ICD_DGNS_CD2,
                                                                         ICD_DGNS_CD3,
                                                                         ICD_DGNS_CD4,
                                                                         ICD_DGNS_CD5,
                                                                         ICD_DGNS_CD6,
                                                                         ICD_DGNS_CD7,
                                                                         ICD_DGNS_CD8,
                                                                         ICD_DGNS_CD9,
                                                                         ICD_DGNS_CD10,
                                                                         ICD_DGNS_CD11,
                                                                         ICD_DGNS_CD12), diabetes_icd_10_codes_2)), is_diabetes:=T]
claim_carrier_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
                                                                         ICD_DGNS_CD1,
                                                                         ICD_DGNS_CD2,
                                                                         ICD_DGNS_CD3,
                                                                         ICD_DGNS_CD4,
                                                                         ICD_DGNS_CD5,
                                                                         ICD_DGNS_CD6,
                                                                         ICD_DGNS_CD7,
                                                                         ICD_DGNS_CD8,
                                                                         ICD_DGNS_CD9,
                                                                         ICD_DGNS_CD10,
                                                                         ICD_DGNS_CD11,
                                                                         ICD_DGNS_CD12), diabetes_icd_10_codes_3)), is_diabetes:=T]
claim_carrier_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
                                                                         ICD_DGNS_CD1,
                                                                         ICD_DGNS_CD2,
                                                                         ICD_DGNS_CD3,
                                                                         ICD_DGNS_CD4,
                                                                         ICD_DGNS_CD5,
                                                                         ICD_DGNS_CD6,
                                                                         ICD_DGNS_CD7,
                                                                         ICD_DGNS_CD8,
                                                                         ICD_DGNS_CD9,
                                                                         ICD_DGNS_CD10,
                                                                         ICD_DGNS_CD11,
                                                                         ICD_DGNS_CD12), diabetes_icd_10_codes_4)), is_diabetes:=T]



claim_carrier_all_years[PRNCPAL_DGNS_VRSN_CD == 9 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
                                                                         ICD_DGNS_CD1,
                                                                         ICD_DGNS_CD2,
                                                                         ICD_DGNS_CD3,
                                                                         ICD_DGNS_CD4,
                                                                         ICD_DGNS_CD5,
                                                                         ICD_DGNS_CD6,
                                                                         ICD_DGNS_CD7,
                                                                         ICD_DGNS_CD8,
                                                                         ICD_DGNS_CD9,
                                                                         ICD_DGNS_CD10,
                                                                         ICD_DGNS_CD11,
                                                                         ICD_DGNS_CD12), depression_icd_9_codes)), is_depression:=T]

claim_carrier_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
                                                                         ICD_DGNS_CD1,
                                                                         ICD_DGNS_CD2,
                                                                         ICD_DGNS_CD3,
                                                                         ICD_DGNS_CD4,
                                                                         ICD_DGNS_CD5,
                                                                         ICD_DGNS_CD6,
                                                                         ICD_DGNS_CD7,
                                                                         ICD_DGNS_CD8,
                                                                         ICD_DGNS_CD9,
                                                                         ICD_DGNS_CD10,
                                                                         ICD_DGNS_CD11,
                                                                         ICD_DGNS_CD12), depression_icd_10_codes)), is_depression:=T]
```

```{r}
nrow(claim_carrier_all_years[is_hypertension==T])
```

```{r}
nrow(claim_carrier_all_years[is_arthritis==T])
```

### Inpatient

```{r tags=c()}
claim_inpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 9 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
ADMTG_DGNS_CD,
ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), hypertension_icd_9_codes)), is_hypertension:=T]

claim_inpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
ADMTG_DGNS_CD,
ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), hypertension_icd_10_codes)), is_hypertension:=T]


claim_inpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 9 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
ADMTG_DGNS_CD,
ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), arthritis_icd_9_codes)), is_arthritis:=T]

claim_inpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
ADMTG_DGNS_CD,
ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), arthritis_icd_10_codes)), is_arthritis:=T]


claim_inpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 9 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
ADMTG_DGNS_CD,
ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), IHD_icd_9_codes)), is_IHD:=T]

claim_inpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
ADMTG_DGNS_CD,
ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), IHD_icd_10_codes)), is_IHD:=T]

claim_inpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 9 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
ADMTG_DGNS_CD,
ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), diabetes_icd_9_codes)), is_diabetes:=T]

claim_inpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
ADMTG_DGNS_CD,
ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), diabetes_icd_10_codes)), is_diabetes:=T]


claim_inpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 9 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
ADMTG_DGNS_CD,
ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), depression_icd_9_codes)), is_depression:=T]

claim_inpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,
ADMTG_DGNS_CD,
ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), depression_icd_10_codes)), is_depression:=T]
```

```{r}
head(claim_inpatient_all_years[is_hypertension==T & is_IHD==T])
```

### Outpatient

```{r tags=c()}
claim_outpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 9 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,

ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), hypertension_icd_9_codes)), is_hypertension:=T]

claim_outpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,

ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), hypertension_icd_10_codes)), is_hypertension:=T]


claim_outpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 9 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,

ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), arthritis_icd_9_codes)), is_arthritis:=T]

claim_outpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,

ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), arthritis_icd_10_codes)), is_arthritis:=T]


claim_outpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 9 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,

ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), IHD_icd_9_codes)), is_IHD:=T]

claim_outpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,

ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), IHD_icd_10_codes)), is_IHD:=T]

claim_outpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 9 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,

ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), diabetes_icd_9_codes)), is_diabetes:=T]

claim_outpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,

ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), diabetes_icd_10_codes)), is_diabetes:=T]


claim_outpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 9 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,

ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), depression_icd_9_codes)), is_depression:=T]

claim_outpatient_all_years[PRNCPAL_DGNS_VRSN_CD == 0 & Reduce(`|`, Map(fmatch, 
                                                                    list(PRNCPAL_DGNS_CD,

ICD_DGNS_CD1,
ICD_DGNS_CD2,
ICD_DGNS_CD3,
ICD_DGNS_CD4,
ICD_DGNS_CD5,
ICD_DGNS_CD6,
ICD_DGNS_CD7,
ICD_DGNS_CD8,
ICD_DGNS_CD9,
ICD_DGNS_CD10,
ICD_DGNS_CD11,
ICD_DGNS_CD12,
ICD_DGNS_CD13,
ICD_DGNS_CD14,
ICD_DGNS_CD15,
ICD_DGNS_CD16,
ICD_DGNS_CD17,
ICD_DGNS_CD18,
ICD_DGNS_CD19,
ICD_DGNS_CD20,
ICD_DGNS_CD21,
ICD_DGNS_CD22,
ICD_DGNS_CD23,
ICD_DGNS_CD24,
ICD_DGNS_CD25), depression_icd_10_codes)), is_depression:=T]
```

```{r}
head(claim_outpatient_all_years[is_hypertension==T & is_depression==T])
```

<!-- #region tags=[] -->
### Summarizing claim level patient data
<!-- #endregion -->

```{r}
claim_level_all_data=rbind(claim_carrier_all_years[,.(DESY_SORT_KEY,
year,
date,
month_year,
is_hypertension,
is_arthritis,
is_IHD,
is_diabetes,
is_depression)]
,claim_inpatient_all_years[,.(DESY_SORT_KEY,
year,
date,
month_year,
is_hypertension,
is_arthritis,
is_IHD,
is_diabetes,
is_depression)])
claim_level_all_data=rbind(claim_level_all_data
,claim_outpatient_all_years[,.(DESY_SORT_KEY,
year,
date,
month_year,
is_hypertension,
is_arthritis,
is_IHD,
is_diabetes,
is_depression)])

head(claim_level_all_data)
```

```{r}
summarise_claim_level <- function(data, time_frame = 365) {
  data %>%
    group_by(DESY_SORT_KEY, year) %>%
    summarise(
      hypertension = sum(is_hypertension, na.rm = T) > 0,
      arthritis = sum(is_arthritis, na.rm = T) > 0,
      IHD = sum(is_IHD, na.rm = T) > 0,
      diabetes = sum(is_diabetes, na.rm = T) > 0,
      depression = sum(is_depression, na.rm = T) > 0,
    ) %>%
    as.data.table()
}

summary_claim_level_patient_by_year <- summarise_claim_level(claim_level_all_data)
```

```{r}
head(summary_claim_level_patient_by_year)
```

```{r}
write_fst(summary_claim_level_patient_by_year, "/work/postresearch/Shared/Projects/Farbod/CaseMix/summary_claim_level_patient_by_year_new_new.fst")
```

<!-- #region tags=[] -->
## Reading the claim level conditions results
<!-- #endregion -->

```{r}
summary_claim_level_patient_by_year=read_fst("/work/postresearch/Shared/Projects/Farbod/CaseMix/summary_claim_level_patient_by_year_new_new.fst",as.data.table = T)
```

```{r}
summary_claim_level_patient_by_year[,year:=as.double(year)]
```

```{r}
head(summary_claim_level_patient_by_year)
```

<!-- #region tags=[] -->
## Adding to the main data
<!-- #endregion -->

```{r}
yearly_calculations <- read_fst("yearly_calculations_cleaned_with_mdppas_with_physician_changes_new.fst", as.data.table = T)
```

```{r}
head(yearly_calculations)
```

```{r}
yearly_calculations=
yearly_calculations %>%
left_join(.,summary_claim_level_patient_by_year,by=c("DESY_SORT_KEY","year"),suffix = c("_old","_carrier"))%>%
mutate(hypertension=hypertension_old|hypertension_carrier,
       arthritis=arthritis_old|arthritis_carrier,
       IHD=IHD_old|IHD_carrier,
       diabetes=diabetes_old|diabetes_carrier,
       depression=depression_old|depression_carrier
      )%>%
as.data.table()
```

```{r}
head(yearly_calculations)
```

## Setting conditions to be same as their lag if true

```{r}
yearly_calculations[DESY_SORT_KEY == "100000015"]
```

```{r}
temp=yearly_calculations %>% 
group_by(DESY_SORT_KEY) %>%
arrange(year)%>%
mutate(arthritis=case_when(lag(arthritis)==T ~ T, T ~ arthritis),
       hypertension=case_when(lag(hypertension)==T ~ T, T ~ hypertension),
       IHD=case_when(lag(IHD)==T ~ T, T ~ IHD),
       diabetes=case_when(lag(diabetes)==T ~ T, T ~ diabetes)
      )%>%
as.data.table()
```

```{r}
temp[DESY_SORT_KEY == "100000015"]
```

```{r}
yearly_calculations <- temp
```

## Counting number of conditions

```{r}
yearly_calculations[, number_of_conditions := sum(hypertension, arthritis, IHD, diabetes, depression, na.rm = T), ,
  by = 1:nrow(yearly_calculations)
]
```

```{r}
head(yearly_calculations)
```

```{r}
write_fst(yearly_calculations, "yearly_calculations_with_integration_changes_mdppas_claim_level.fst")
```

## Patient pool changes

<!-- #region tags=[] -->
### Read cleaned results
<!-- #endregion -->

```{r}
# yearly_calculations <- read_fst("yearly_calculations_cleaned.fst", as.data.table = T)
yearly_calculations <- read_fst("yearly_calculations_with_integration_changes_mdppas_claim_level.fst", as.data.table = T)
```

```{r}
yearly_calculations[DESY_SORT_KEY == "100005325"]
```

<!-- #region jp-MarkdownHeadingCollapsed=true tags=[] -->
### Summarize Changes
<!-- #endregion -->

```{r}
integration_change_summarizer <- function(data) {
  require(tidyverse)
  require(dtplyr)

  result <-
    data %>%
    filter(!is.na(most_common_primary_care_physician_years_from_integration)) %>%
    group_by(most_common_primary_care_physician_years_from_integration) %>%
    summarise(
      hypertension = mean(hypertension, na.rm = T),
      arthritis = mean(arthritis, na.rm = T),
      IHD = mean(IHD, na.rm = T),
      diabetes = mean(diabetes, na.rm = T),
      depression = mean(depression, na.rm = T),
      two_conditions = mean(number_of_conditions == 2, na.rm = T),
      more_than_two_conditions = mean(number_of_conditions > 2, na.rm = T)
    ) %>%
    as.data.table()
}
```

```{r}
integration_changes_years_to_integration <- integration_change_summarizer(yearly_calculations)
```

```{r}
integration_changes_years_to_integration
```

```{r}
ggplot_all_variables <- ggplot(data = integration_changes_years_to_integration) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black", size = 1.5) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = hypertension, color = "hypertension")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = hypertension, color = "hypertension")) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = arthritis, color = "arthritis")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = arthritis, color = "arthritis")) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = IHD, color = "IHD")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = IHD, color = "IHD")) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = diabetes, color = "diabetes")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = diabetes, color = "diabetes")) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = depression, color = "depression")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = depression, color = "depression")) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = two_conditions, color = "two_conditions")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = two_conditions, color = "two_conditions")) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = more_than_two_conditions, color = "more_than_two_conditions")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = more_than_two_conditions, color = "more_than_two_conditions")) +
  scale_colour_discrete() +
  scale_x_continuous(breaks = seq(-8, 8, 2)) +
  xlab("Primary care physician years from integration") +
  ylab("Prevalence")

ggsave(ggplot_all_variables, filename = "ggplot_all_variables.pdf", width = 12, height = 7)
```

```{r}
ggplot_hypertension <- ggplot(data = integration_changes_years_to_integration) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black", size = 1.5) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = hypertension, color = "hypertension")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = hypertension, color = "hypertension")) +
  scale_colour_discrete() +
  scale_x_continuous(breaks = seq(-8, 8, 2)) +
  xlab("Primary care physician years from integration") +
  ylab("Prevalence")

ggsave(ggplot_hypertension, filename = "ggplot_hypertension.pdf", width = 12, height = 7)
```

```{r}
ggplot_arthritis_depression_more_than_two <- ggplot(data = integration_changes_years_to_integration) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black", size = 1.5) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = arthritis, color = "arthritis")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = arthritis, color = "arthritis")) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = depression, color = "depression")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = depression, color = "depression")) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = more_than_two_conditions, color = "more_than_two_conditions")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = more_than_two_conditions, color = "more_than_two_conditions")) +
  scale_colour_discrete() +
  scale_x_continuous(breaks = seq(-8, 8, 2)) +
  xlab("Primary care physician years from integration") +
  ylab("Prevalence")

ggsave(ggplot_arthritis_depression_more_than_two, filename = "ggplot_arthritis_depression_more_than_two.pdf", width = 12, height = 7)
```

```{r}
ggplot_IHD_diabetes_two_conditions <- ggplot(data = integration_changes_years_to_integration) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black", size = 1.5) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = IHD, color = "IHD")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = IHD, color = "IHD")) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = diabetes, color = "diabetes")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = diabetes, color = "diabetes")) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = two_conditions, color = "two_conditions")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = two_conditions, color = "two_conditions")) +
  scale_colour_discrete() +
  scale_x_continuous(breaks = seq(-8, 8, 2)) +
  xlab("Primary care physician years from integration") +
  ylab("Prevalence")

ggsave(ggplot_IHD_diabetes_two_conditions, filename = "ggplot_IHD_diabetes_two_conditions.pdf", width = 12, height = 7)
```

```{r}
ggplot_hypertension_rdd <- ggplot(data = integration_changes_years_to_integration %>% mutate(before = (most_common_primary_care_physician_years_from_integration < 0)) %>% as.data.frame()) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black", size = 1.5) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = hypertension, color = "hypertension")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = hypertension, color = "hypertension")) +
  scale_colour_discrete() +
  scale_x_continuous(breaks = seq(-8, 8, 2)) +
  xlab("Primary care physician years from integration") +
  ylab("Prevalence") +
  geom_smooth(method = "lm", aes(x = most_common_primary_care_physician_years_from_integration, y = hypertension, color = "hypertension", fill = "hypertension", group = before))



ggsave(ggplot_hypertension_rdd, filename = "ggplot_hypertension_rdd.pdf", width = 12, height = 7)
```

```{r}
ggplot_IHD_diabetes_two_conditions_rdd <- ggplot(data = integration_changes_years_to_integration %>% mutate(before = (most_common_primary_care_physician_years_from_integration < 0)) %>% as.data.frame()) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black", size = 1.5) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = IHD, color = "IHD")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = IHD, color = "IHD")) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = diabetes, color = "diabetes")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = diabetes, color = "diabetes")) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = two_conditions, color = "two_conditions")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = two_conditions, color = "two_conditions")) +
  scale_colour_discrete() +
  scale_x_continuous(breaks = seq(-8, 8, 2)) +
  xlab("Primary care physician years from integration") +
  ylab("Prevalence") +
  geom_smooth(method = "lm", aes(x = most_common_primary_care_physician_years_from_integration, y = IHD, color = "IHD", fill = "IHD", group = before)) +
  geom_smooth(method = "lm", aes(x = most_common_primary_care_physician_years_from_integration, y = diabetes, color = "diabetes", fill = "diabetes", group = before)) +
  geom_smooth(method = "lm", aes(x = most_common_primary_care_physician_years_from_integration, y = two_conditions, color = "two_conditions", fill = "two_conditions", group = before))



ggsave(ggplot_IHD_diabetes_two_conditions_rdd, filename = "ggplot_IHD_diabetes_two_conditions_rdd.pdf", width = 12, height = 7)
```

```{r}
ggplot_arthritis_depression_more_than_two_rdd <-
  ggplot(data = integration_changes_years_to_integration %>% mutate(before = (most_common_primary_care_physician_years_from_integration < 0)) %>% as.data.frame()) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black", size = 1.5) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = arthritis, color = "arthritis")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = arthritis, color = "arthritis")) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = depression, color = "depression")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = depression, color = "depression")) +
  geom_line(aes(x = most_common_primary_care_physician_years_from_integration, y = more_than_two_conditions, color = "more_than_two_conditions")) +
  geom_point(aes(x = most_common_primary_care_physician_years_from_integration, y = more_than_two_conditions, color = "more_than_two_conditions")) +
  scale_colour_discrete() +
  scale_x_continuous(breaks = seq(-8, 8, 2)) +
  xlab("Primary care physician years from integration") +
  ylab("Prevalence") +
  geom_smooth(method = "lm", aes(x = most_common_primary_care_physician_years_from_integration, y = arthritis, color = "arthritis", fill = "arthritis", group = before)) +
  geom_smooth(method = "lm", aes(x = most_common_primary_care_physician_years_from_integration, y = depression, color = "depression", fill = "depression", group = before)) +
  geom_smooth(method = "lm", aes(x = most_common_primary_care_physician_years_from_integration, y = more_than_two_conditions, color = "more_than_two_conditions", fill = "more_than_two_conditions", group = before))

ggsave(ggplot_arthritis_depression_more_than_two_rdd, filename = "ggplot_arthritis_depression_more_than_two_rdd.pdf", width = 12, height = 7)
```

<!-- #region jp-MarkdownHeadingCollapsed=true tags=[] -->
# Comparisons based on integration status
<!-- #endregion -->

<!-- #region tags=[] -->
## Read cleaned results
<!-- #endregion -->

```{r}
# yearly_calculations <- read_fst("yearly_calculations_cleaned.fst", as.data.table = T)
yearly_calculations <- read_fst("yearly_calculations_with_integration_changes_mdppas_claim_level.fst", as.data.table = T)
```

```{r}
yearly_calculations[DESY_SORT_KEY == "100005325"]
```

<!-- #region tags=[] -->
## Comparison functions
<!-- #endregion -->

```{r}
comparator_averages <- function(data) {
  require(tidyverse)
  require(dtplyr)


  result <- data %>%
    group_by(most_common_primary_care_physician_integrated) %>%
    summarise(
      n = n(),
      N_distinct_patients = length(unique(DESY_SORT_KEY)),
      N_distinct_specialist = length(unique(most_common_primary_care_physician_PRF_PHYSN_NPI)),
      Male = mean(sex == "Male", na.rm = T),
      Female = mean(sex == "Female", na.rm = T),
      Asian = mean(race == "Asian", na.rm = T),
      Black = mean(race == "Black", na.rm = T),
      Hispanic = mean(race == "Hispanic", na.rm = T),
      North_American_Native = mean(race == "North American Native", na.rm = T),
      White = mean(race == "White", na.rm = T),
      Other_race = mean(race == "Other", na.rm = T),
      avg_age = mean(AGE, na.rm = T),
      age_65_74 = mean(na.rm = T, age_group == "65-74"),
      age_75_84 = mean(na.rm = T, age_group == "75-84"),
      age_85_plus = mean(na.rm = T, age_group == "85+"),

      # West=mean(na.rm=T,census_region=="West"),
      # South=mean(na.rm=T,census_region=="South"),
      # Northeast=mean(na.rm=T,census_region=="Northeast"),
      # Midwest=mean(na.rm=T,census_region=="Midwest"),

      rural_prp = mean(RUCC_2013 > 3, na.rm = T),
      urban_prp = mean(RUCC_2013 <= 3, na.rm = T),
      hypertension = mean(hypertension, na.rm = T),
      arthritis = mean(arthritis, na.rm = T),
      IHD = mean(IHD, na.rm = T),
      diabetes = mean(diabetes, na.rm = T),
      depression = mean(depression, na.rm = T),
      two_conditions = mean(number_of_conditions == 2, na.rm = T),
      more_than_two_conditions = mean(number_of_conditions > 2, na.rm = T),
      # primary_care_physician_integrated =
      #  sum(most_common_primary_care_physician_in_facility_non_exclusive_HCPCS_prp >= integration_threshold, na.rm = T) / n(),
      # most_common_physician_integrated =
      #  sum(most_common_physician_in_facility_non_exclusive_HCPCS_prp >= integration_threshold, na.rm = T) / n()
    ) %>%
    as.data.table()

  return(result)
}
```

```{r}
comparator_tests <- function(data) {
  require(tidyverse)
  require(dtplyr)

  result <- data %>%
    mutate(
      integration_status = most_common_primary_care_physician_integrated
    ) %>%
    summarise(
      Male = chisq.test(sex == "Male", integration_status)$p.value,
      Female = chisq.test(sex == "Female", integration_status)$p.value,
      Asian = chisq.test(race == "Asian", integration_status)$p.value,
      Black = chisq.test(race == "Black", integration_status)$p.value,
      Hispanic = chisq.test(race == "Hispanic", integration_status)$p.value,
      North_American_Native = chisq.test(race == "North American Native", integration_status)$p.value,
      White = chisq.test(race == "White", integration_status)$p.value,
      Other_race = chisq.test(race == "Other", integration_status)$p.value,
      avg_age = t.test(AGE ~ integration_status, data = .)$p.value,
      age_65_74 = chisq.test(age_group == "65-74", integration_status)$p.value,
      age_75_84 = chisq.test(age_group == "75-84", integration_status)$p.value,
      age_85_plus = chisq.test(age_group == "85+", integration_status)$p.value,

      # West=mean(na.rm=T,census_region=="West"),
      # South=mean(na.rm=T,census_region=="South"),
      # Northeast=mean(na.rm=T,census_region=="Northeast"),
      # Midwest=mean(na.rm=T,census_region=="Midwest"),

      rural_prp = chisq.test(RUCC_2013 > 3, integration_status)$p.value,
      urban_prp = chisq.test(RUCC_2013 <= 3, integration_status)$p.value,
      hypertension = chisq.test(hypertension, integration_status)$p.value,
      arthritis = chisq.test(arthritis, integration_status)$p.value,
      IHD = chisq.test(IHD, integration_status)$p.value,
      diabetes = chisq.test(diabetes, integration_status)$p.value,
      depression = chisq.test(depression, integration_status)$p.value,
      two_conditions = chisq.test(number_of_conditions == 2, integration_status)$p.value,
      more_than_two_conditions = chisq.test(number_of_conditions > 2, integration_status)$p.value,
    ) %>%
    as.data.table()

  return(result)
}
```

```{r}
overall_averages <- function(data) {
  require(tidyverse)
  require(dtplyr)


  result <- data %>%
    summarise(
      n = n(),
      N_distinct_patients = length(unique(DESY_SORT_KEY)),
      N_distinct_specialist = length(unique(most_common_primary_care_physician_PRF_PHYSN_NPI)),
      Male = mean(sex == "Male", na.rm = T),
      Female = mean(sex == "Female", na.rm = T),
      Asian = mean(race == "Asian", na.rm = T),
      Black = mean(race == "Black", na.rm = T),
      Hispanic = mean(race == "Hispanic", na.rm = T),
      North_American_Native = mean(race == "North American Native", na.rm = T),
      White = mean(race == "White", na.rm = T),
      Other_race = mean(race == "Other", na.rm = T),
      avg_age = mean(AGE, na.rm = T),
      age_65_74 = mean(na.rm = T, age_group == "65-74"),
      age_75_84 = mean(na.rm = T, age_group == "75-84"),
      age_85_plus = mean(na.rm = T, age_group == "85+"),

      # West=mean(na.rm=T,census_region=="West"),
      # South=mean(na.rm=T,census_region=="South"),
      # Northeast=mean(na.rm=T,census_region=="Northeast"),
      # Midwest=mean(na.rm=T,census_region=="Midwest"),

      rural_prp = mean(RUCC_2013 > 3, na.rm = T),
      urban_prp = mean(RUCC_2013 <= 3, na.rm = T),
      hypertension = mean(hypertension, na.rm = T),
      arthritis = mean(arthritis, na.rm = T),
      IHD = mean(IHD, na.rm = T),
      diabetes = mean(diabetes, na.rm = T),
      depression = mean(depression, na.rm = T),
      two_conditions = mean(number_of_conditions == 2, na.rm = T),
      more_than_two_conditions = mean(number_of_conditions > 2, na.rm = T),
      # primary_care_physician_integrated =
      #  sum(most_common_primary_care_physician_in_facility_non_exclusive_HCPCS_prp >= integration_threshold, na.rm = T) / n(),
      # most_common_physician_integrated =
      #  sum(most_common_physician_in_facility_non_exclusive_HCPCS_prp >= integration_threshold, na.rm = T) / n()
    ) %>%
    as.data.table()

  return(result)
}
```

```{r}
primary_care_physician_comparisons_averages <-
  comparator_averages(yearly_calculations)

primary_care_physician_comparisons_test <-
  comparator_tests(yearly_calculations)

primary_care_physician_overall_averages <-
  overall_averages(yearly_calculations)
```

```{r}
primary_care_physician_comparisons_averages
```

```{r}
primary_care_physician_comparisons_test
```

```{r}
primary_care_physician_overall_averages
```

```{r}
comparison_results_primary_care_physician <- rbind(
  primary_care_physician_overall_averages,
  primary_care_physician_comparisons_averages,
  primary_care_physician_comparisons_test,
  fill = TRUE
)
t(comparison_results_primary_care_physician)
```

# Finding the prevelances of the chronic conditions in patients entering and exiting

<!-- #region tags=[] -->
## Read cleaned results
<!-- #endregion -->

```{r}
# yearly_calculations <- read_fst("yearly_calculations_cleaned.fst", as.data.table = T)
yearly_calculations <- read_fst("yearly_calculations_with_integration_changes_mdppas_claim_level.fst", as.data.table = T)
```

```{r}
yearly_calculations[DESY_SORT_KEY == "100005325"]
```

## Find entering, exiting, and remaining patients

```{r}
yearly_calculations <- yearly_calculations %>%
  mutate(
    exit_enter_status = case_when(
      most_common_primary_care_physician_integration_change == "newly_integrated" &
        most_common_primary_care_physician_changed == "FALSE" ~ "Remaining",
      most_common_primary_care_physician_integration_change == "newly_integrated" &
        most_common_primary_care_physician_changed == "TRUE" ~ "Entering",
      last_year_most_common_primary_care_physician_integration_change == "newly_integrated" &
        most_common_primary_care_physician_changed == "TRUE" ~ "Exiting"
    )
  ) %>%
  as.data.table()
yearly_calculations[DESY_SORT_KEY == "100005325"]
```

```{r}
comparator_exit_enter <- function(data) {
  require(tidyverse)
  require(dtplyr)


  result <- data %>%
    group_by(exit_enter_status) %>%
    summarise(
      n = n(),
      N_distinct_patients = length(unique(DESY_SORT_KEY)),
      N_distinct_specialist = length(unique(most_common_primary_care_physician_PRF_PHYSN_NPI)),
      Male = mean(sex == "Male", na.rm = T),
      Female = mean(sex == "Female", na.rm = T),
      Asian = mean(race == "Asian", na.rm = T),
      Black = mean(race == "Black", na.rm = T),
      Hispanic = mean(race == "Hispanic", na.rm = T),
      North_American_Native = mean(race == "North American Native", na.rm = T),
      White = mean(race == "White", na.rm = T),
      Other_race = mean(race == "Other", na.rm = T),
      avg_age = mean(AGE, na.rm = T),
      age_65_74 = mean(na.rm = T, age_group == "65-74"),
      age_75_84 = mean(na.rm = T, age_group == "75-84"),
      age_85_plus = mean(na.rm = T, age_group == "85+"),

      # West=mean(na.rm=T,census_region=="West"),
      # South=mean(na.rm=T,census_region=="South"),
      # Northeast=mean(na.rm=T,census_region=="Northeast"),
      # Midwest=mean(na.rm=T,census_region=="Midwest"),

      rural_prp = mean(RUCC_2013 > 3, na.rm = T),
      urban_prp = mean(RUCC_2013 <= 3, na.rm = T),
      hypertension = mean(hypertension, na.rm = T),
      arthritis = mean(arthritis, na.rm = T),
      IHD = mean(IHD, na.rm = T),
      diabetes = mean(diabetes, na.rm = T),
      depression = mean(depression, na.rm = T),
      two_conditions = mean(number_of_conditions == 2, na.rm = T),
      more_than_two_conditions = mean(number_of_conditions > 2, na.rm = T),
      died_the_year_of_integration = mean(year == year_of_death, na.rm = T)

      # primary_care_physician_integrated =
      #  sum(most_common_primary_care_physician_in_facility_non_exclusive_HCPCS_prp >= integration_threshold, na.rm = T) / n(),
      # most_common_physician_integrated =
      #  sum(most_common_physician_in_facility_non_exclusive_HCPCS_prp >= integration_threshold, na.rm = T) / n()
    ) %>%
    as.data.table()

  return(result)
}
```

```{r}
exit_enter_comparisons <- t(comparator_exit_enter(yearly_calculations))
```

```{r}
exit_enter_comparisons
```

# Conditions in the dropping patients.


## In integrating doctors

```{r}
exit_conditions <- function(data) {
  require(tidyverse)
  require(dtplyr)


  results_1 <- data %>%
    group_by(last_year_most_common_primary_care_physician_PRF_PHYSN_NPI) %>%
    summarise(
      n_exiting_patients = length(unique(.[exit_enter_status == "Exiting", DESY_SORT_KEY])),
      mortality = mean(.[exit_enter_status == "Exiting", year == year_of_death], na.rm = T),
      received_primary_care_elsewhere =
        mean(.[
          last_year_most_common_primary_care_physician_integration_change == "newly_integrated",
          !is.na(most_common_primary_care_physician_PRF_PHYSN_NPI)
        ], na.rm = T)
    ) %>%
    as.data.table()

  results_2 <- data %>%
    filter(most_common_primary_care_physician_years_from_integration == -1) %>%
    group_by(most_common_primary_care_physician_PRF_PHYSN_NPI) %>%
    summarise(n_patients_year_before_integration = length(unique(DESY_SORT_KEY))) %>%
    as.data.table()

  results <- inner_join(results_1, results_2, by = c("last_year_most_common_primary_care_physician_PRF_PHYSN_NPI" = "most_common_primary_care_physician_PRF_PHYSN_NPI")) %>%
    mutate(dropped_prp = n_exiting_patients / n_patients_year_before_integration) %>%
    as.data.table()

  result <- results %>%
    summarise(
      dropped_prp = mean(dropped_prp, na.rm = T),
      mortality_prp = mean(mortality, na.rm = T),
      received_primary_care_elsewhere = mean(received_primary_care_elsewhere, na.rm = T)
    ) %>%
    as.data.table()

  return(results)
}
```

```{r}
results_exit_conditions_integrating <- exit_conditions(yearly_calculations)
```

```{r}
head(results_exit_conditions_integrating)
```

## In independent docs

```{r}
exit_conditions_all <- function(data) {
  require(tidyverse)
  require(dtplyr)

  results_1 <- data %>%
    filter(last_year_most_common_primary_care_physician_never_integrated == T) %>%
    group_by(last_year_most_common_primary_care_physician_PRF_PHYSN_NPI) %>%
    summarise(
      n_exiting_patients = length(unique(.[most_common_primary_care_physician_changed == TRUE, DESY_SORT_KEY])),
      mortality = mean(.[most_common_primary_care_physician_changed == TRUE, year == year_of_death], na.rm = T),
      received_primary_care_elsewhere =
        mean(!is.na(most_common_primary_care_physician_PRF_PHYSN_NPI), na.rm = T)
    ) %>%
    as.data.table()

  results_2 <- data %>%
    filter(most_common_primary_care_physician_never_integrated == T) %>%
    group_by(most_common_primary_care_physician_PRF_PHYSN_NPI) %>%
    summarise(n_patients_all_years = length(unique(DESY_SORT_KEY))) %>%
    as.data.table()

  results <- inner_join(results_1, results_2,
    by =
      c(
        "last_year_most_common_primary_care_physician_PRF_PHYSN_NPI" =
          "most_common_primary_care_physician_PRF_PHYSN_NPI"
      )
  ) %>%
    mutate(dropped_prp = n_exiting_patients / n_patients_all_years) %>%
    as.data.table()

  result <- results %>%
    summarise(
      dropped_prp = mean(dropped_prp, na.rm = T),
      mortality_prp = mean(mortality, na.rm = T),
      received_primary_care_elsewhere = mean(received_primary_care_elsewhere, na.rm = T)
    ) %>%
    as.data.table()

  return(results)
}
```

```{r}
results_exit_conditions_all <- exit_conditions_all(yearly_calculations)
```

```{r}
head(results_exit_conditions_all)
```

## Comparison test

```{r}
t.test(results_exit_conditions_all$mortality, results_exit_conditions_integrating$mortality)
```

```{r}
t.test(
  results_exit_conditions_all$received_primary_care_elsewhere,
  results_exit_conditions_integrating$received_primary_care_elsewhere
)
```

```{r}
t.test(
  results_exit_conditions_all$dropped_prp,
  results_exit_conditions_integrating$dropped_prp
)
```

# Export for Brady

```{r}
colnames(yearly_calculations)
```

```{r}
brady_data <-
yearly_calculations[,.(DESY_SORT_KEY,
                       year,
                       most_common_primary_care_physician_PRF_PHYSN_NPI,
                       AGE,
                       sex,
                       race,
                       urban,
                       arthritis,
                       depression,
                       diabetes,
                       hypertension,
                       IHD,
                       number_of_conditions,
                       distinct_primary_care_physicians,
                       most_common_primary_care_physician_changed,
                       exit_enter_status,
                       year_of_death
                      )]
```

```{r}
write.csv(x=brady_data,file="patient_composition_data_for_brady.csv")
```

```{r}

```
